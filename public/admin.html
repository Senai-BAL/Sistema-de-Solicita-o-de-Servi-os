<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SENAI Lab - Dashboard Administrativo v2</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      min-height: 100vh;
      color: #333;
    }

    /* ===== MODAL STYLES ===== */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(5px);
    }

    .modal.show {
      display: flex;
      justify-content: center;
      align-items: center;
      animation: fadeIn 0.3s ease;
    }

    .modal-content {
      background: white;
      border-radius: 16px;
      padding: 30px;
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
      position: relative;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f1f3f4;
    }

    .modal-title {
      font-size: 1.5rem;
      color: #1e3c72;
      font-weight: 600;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #666;
      padding: 5px;
      border-radius: 50%;
      transition: all 0.3s ease;
    }

    .close-btn:hover {
      background: #f1f3f4;
      color: #333;
    }

    /* ===== TOAST NOTIFICATIONS ===== */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1100;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .toast {
      background: white;
      border-radius: 8px;
      padding: 15px 20px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      min-width: 300px;
      display: flex;
      align-items: center;
      gap: 10px;
      transform: translateX(400px);
      transition: all 0.3s ease;
      border-left: 4px solid #4285f4;
    }

    .toast.show {
      transform: translateX(0);
    }

    .toast.success {
      border-left-color: #27ae60;
    }

    .toast.error {
      border-left-color: #e74c3c;
    }

    .toast.warning {
      border-left-color: #f39c12;
    }

    .toast-icon {
      font-size: 1.2rem;
    }

    .toast-message {
      flex: 1;
      font-weight: 500;
    }

    .toast-close {
      background: none;
      border: none;
      cursor: pointer;
      color: #666;
      font-size: 1.1rem;
    }

    /* ===== SEARCH AND FILTERS ===== */
    .search-container {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      align-items: end;
    }

    .search-box {
      flex: 1;
      min-width: 200px;
    }

    .search-box input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e1e5e9;
      border-radius: 8px;
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    .search-box input:focus {
      outline: none;
      border-color: #4285f4;
      box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.1);
    }

    /* ===== IMPROVED REQUEST CARDS ===== */
    .request-card {
      border: 1px solid #e1e5e9;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 15px;
      background: white;
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    .request-card:hover {
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
      transform: translateY(-2px);
    }

    .request-card.priority-alta {
      border-left: 5px solid #e74c3c;
    }

    .request-card.priority-media {
      border-left: 5px solid #f39c12;
    }

    .request-card.priority-baixa {
      border-left: 5px solid #27ae60;
    }

    .priority-indicator {
      position: absolute;
      top: 15px;
      right: 15px;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .priority-alta {
      background: #fee;
      color: #e74c3c;
    }

    .priority-media {
      background: #fff8e7;
      color: #f39c12;
    }

    .priority-baixa {
      background: #eafaf1;
      color: #27ae60;
    }

    /* ===== DRAG AND DROP STATUS ===== */
    .status-columns {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .status-column {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 20px;
      min-height: 400px;
    }

    .status-column h3 {
      text-align: center;
      margin-bottom: 15px;
      padding: 10px;
      border-radius: 8px;
      font-weight: 600;
    }

    .status-pendente h3 {
      background: #ffeaa7;
      color: #d63031;
    }

    .status-em_andamento h3 {
      background: #74b9ff;
      color: white;
    }

    .status-concluido h3 {
      background: #00b894;
      color: white;
    }

    .status-cancelado h3 {
      background: #d63031;
      color: white;
    }

    .kanban-card {
      background: white;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      cursor: grab;
      transition: all 0.3s ease;
    }

    .kanban-card:hover {
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
    }

    .kanban-card.dragging {
      opacity: 0.5;
      transform: rotate(5deg);
    }

    /* ===== EXPORT BUTTONS ===== */
    .export-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .btn-export {
      background: #27ae60;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.3s ease;
    }

    .btn-export:hover {
      background: #229954;
    }

    .btn-export.excel {
      background: #2e7d32;
    }

    .btn-export.pdf {
      background: #d32f2f;
    }

    /* ===== QUICK ACTIONS ===== */
    .quick-actions {
      display: flex;
      gap: 8px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .quick-action {
      padding: 4px 8px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8rem;
      transition: all 0.3s ease;
    }

    .quick-action.priority {
      background: #fff3cd;
      color: #856404;
    }

    .quick-action.comment {
      background: #d1ecf1;
      color: #0c5460;
    }

    .quick-action.details {
      background: #e2e3e5;
      color: #383d41;
    }

    .quick-action:hover {
      transform: scale(1.05);
    }

    /* ===== STATS IMPROVEMENTS ===== */
    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: linear-gradient(45deg, #667eea, #764ba2);
    }

    /* ===== RESPONSIVE IMPROVEMENTS ===== */
    @media (max-width: 768px) {
      .status-columns {
        grid-template-columns: 1fr;
      }
      
      .search-container {
        flex-direction: column;
        gap: 10px;
      }
      
      .export-buttons {
        flex-wrap: wrap;
      }
      
      .modal-content {
        width: 95%;
        padding: 20px;
      }
    }

    /* ===== LOADING IMPROVEMENTS ===== */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.9);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 999;
      backdrop-filter: blur(2px);
    }

    .loading-content {
      text-align: center;
      color: #1e3c72;
    }

    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }

    /* ===== ANIMATIONS ===== */
    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }

    @keyframes slideIn {
      from { transform: translateX(100%); }
      to { transform: translateX(0); }
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* ===== PRESERVE EXISTING STYLES ===== */
    .login-container {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }

    .login-box {
      background: white;
      border-radius: 16px;
      padding: 40px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      width: 100%;
      max-width: 400px;
      text-align: center;
    }

    .login-header h1 {
      color: #1e3c72;
      font-size: 2rem;
      margin-bottom: 10px;
    }

    .login-header p {
      color: #666;
      font-size: 0.9rem;
    }

    .form-group {
      margin-bottom: 20px;
      text-align: left;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
    }

    .form-group input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e1e5e9;
      border-radius: 8px;
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    .form-group input:focus {
      outline: none;
      border-color: #4285f4;
      box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.1);
    }

    .btn {
      background: linear-gradient(45deg, #667eea, #764ba2);
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 100%;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
    }

    .btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    .error-message {
      color: #e74c3c;
      font-size: 0.9rem;
      margin-top: 10px;
      padding: 10px;
      background: #fdf2f2;
      border-radius: 6px;
      border: 1px solid #fecaca;
      display: none;
    }

    .dashboard {
      display: none;
      min-height: 100vh;
      background: #f8f9fa;
    }

    .dashboard.show {
      display: block;
    }

    .navbar {
      background: white;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      padding: 0 20px;
      height: 70px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .navbar-brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .navbar-brand h1 {
      color: #1e3c72;
      font-size: 1.5rem;
    }

    .navbar-user {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .user-info {
      text-align: right;
    }

    .user-name {
      font-weight: 600;
      color: #333;
      font-size: 0.9rem;
    }

    .user-role {
      color: #666;
      font-size: 0.8rem;
    }

    .btn-logout {
      background: #e74c3c;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.3s ease;
    }

    .btn-logout:hover {
      background: #c0392b;
    }

    .main-content {
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 15px;
    }

    .stat-title {
      color: #666;
      font-size: 0.9rem;
      font-weight: 500;
    }

    .stat-icon {
      font-size: 1.5rem;
    }

    .stat-value {
      font-size: 2.2rem;
      font-weight: 700;
      color: #1e3c72;
    }

    .stat-change {
      font-size: 0.8rem;
      margin-top: 5px;
    }

    .stat-change.positive {
      color: #27ae60;
    }

    .stat-change.negative {
      color: #e74c3c;
    }

    .content-section {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f1f3f4;
    }

    .section-title {
      font-size: 1.3rem;
      color: #1e3c72;
      font-weight: 600;
    }

    .filters {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .filter-group label {
      font-size: 0.8rem;
      color: #666;
      font-weight: 500;
    }

    .filter-group select {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 0.9rem;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .spinner {
      display: inline-block;
      width: 30px;
      height: 30px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay" style="display: none;">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <h3>Processando...</h3>
      <p id="loadingMessage">Carregando dados...</p>
    </div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- Tela de Login -->
  <div class="login-container" id="loginContainer">
    <div class="login-box">
      <div class="login-header">
        <h1>🔧 SENAI Lab</h1>
        <p>Dashboard Administrativo v2.0</p>
      </div>
      <form id="loginForm">
        <div class="form-group">
          <label for="adminPassword">Senha de Acesso</label>
          <input 
            type="password" 
            id="adminPassword" 
            placeholder="Digite a senha administrativa"
            required
          >
        </div>
        <button type="submit" class="btn" id="loginBtn">
          <span id="loginText">🔐 Entrar</span>
          <span id="loginLoading" style="display: none;">⏳ Verificando...</span>
        </button>
        <div class="error-message" id="loginError"></div>
      </form>
    </div>
  </div>

  <!-- Dashboard Principal -->
  <div class="dashboard" id="dashboard">
    <!-- Navbar -->
    <nav class="navbar">
      <div class="navbar-brand">
        <span>🔧</span>
        <h1>SENAI Lab - Admin v2.0</h1>
      </div>
      <div class="navbar-user">
        <div class="user-info">
          <div class="user-name">Administrador</div>
          <div class="user-role">Dashboard Avançado</div>
        </div>
        <button class="btn-logout" onclick="logout()">🚪 Sair</button>
      </div>
    </nav>

    <!-- Conteúdo Principal -->
    <main class="main-content">
      <!-- Cards de Estatísticas -->
      <div class="stats-grid">
        <div class="stat-card" onclick="filterByStatus('')">
          <div class="stat-header">
            <span class="stat-title">Total de Solicitações</span>
            <span class="stat-icon">📋</span>
          </div>
          <div class="stat-value" id="totalRequests">-</div>
          <div class="stat-change positive" id="totalChange">Carregando...</div>
        </div>

        <div class="stat-card" onclick="filterByStatus('pendente')">
          <div class="stat-header">
            <span class="stat-title">Pendentes</span>
            <span class="stat-icon">⏳</span>
          </div>
          <div class="stat-value" id="pendingRequests">-</div>
          <div class="stat-change" id="pendingChange">Carregando...</div>
        </div>

        <div class="stat-card" onclick="filterByStatus('em_andamento')">
          <div class="stat-header">
            <span class="stat-title">Em Andamento</span>
            <span class="stat-icon">🔄</span>
          </div>
          <div class="stat-value" id="inProgressRequests">-</div>
          <div class="stat-change" id="progressChange">Carregando...</div>
        </div>

        <div class="stat-card" onclick="filterByStatus('concluido')">
          <div class="stat-header">
            <span class="stat-title">Concluídas</span>
            <span class="stat-icon">✅</span>
          </div>
          <div class="stat-value" id="completedRequests">-</div>
          <div class="stat-change positive" id="completedChange">Carregando...</div>
        </div>
      </div>

      <!-- Seção de Solicitações -->
      <div class="content-section">
        <div class="section-header">
          <h2 class="section-title">📋 Gestão de Solicitações</h2>
          <div class="export-buttons">
            <button class="btn-export excel" onclick="exportToExcel()">📊 Excel</button>
            <button class="btn-export pdf" onclick="exportToPDF()">📄 PDF</button>
          </div>
        </div>

        <!-- Busca e Filtros Avançados -->
        <div class="search-container">
          <div class="search-box">
            <input 
              type="text" 
              id="searchInput" 
              placeholder="🔍 Buscar por nome, email, descrição..."
              oninput="applySearchFilter()"
            >
          </div>
          
          <div class="filter-group">
            <label>Tipo de Serviço</label>
            <select id="filterService" onchange="loadDashboard()">
              <option value="">Todos os tipos</option>
              <option value="espaco_maker">Espaço Maker</option>
              <option value="servicos">Serviços</option>
              <option value="emprestimo">Empréstimo</option>
            </select>
          </div>
          
          <div class="filter-group">
            <label>Status</label>
            <select id="filterStatus" onchange="loadDashboard()">
              <option value="">Todos os status</option>
              <option value="pendente">Pendente</option>
              <option value="em_andamento">Em Andamento</option>
              <option value="concluido">Concluído</option>
              <option value="cancelado">Cancelado</option>
            </select>
          </div>

          <div class="filter-group">
            <label>Prioridade</label>
            <select id="filterPriority" onchange="loadDashboard()">
              <option value="">Todas as prioridades</option>
              <option value="alta">Alta</option>
              <option value="media">Média</option>
              <option value="baixa">Baixa</option>
            </select>
          </div>

          <div class="filter-group">
            <label>Período</label>
            <select id="filterPeriod" onchange="loadDashboard()">
              <option value="hoje">Hoje</option>
              <option value="semana">Esta Semana</option>
              <option value="mes">Este Mês</option>
              <option value="todos">Todos</option>
            </select>
          </div>
        </div>

        <!-- Toggle View Mode -->
        <div style="margin-bottom: 20px;">
          <button 
            id="viewModeBtn" 
            onclick="toggleViewMode()" 
            style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;"
          >
            📋 Alternar para Kanban
          </button>
        </div>

        <!-- Lista de Solicitações (Modo Lista) -->
        <div id="listView">
          <div id="requestsList">
            <div class="loading">
              <div class="spinner"></div>
              <p>Carregando solicitações...</p>
            </div>
          </div>
        </div>

        <!-- Kanban Board (Modo Kanban) -->
        <div id="kanbanView" style="display: none;">
          <div class="status-columns">
            <div class="status-column status-pendente">
              <h3>⏳ Pendente</h3>
              <div id="kanban-pendente" class="kanban-drop-zone"></div>
            </div>
            <div class="status-column status-em_andamento">
              <h3>🔄 Em Andamento</h3>
              <div id="kanban-em_andamento" class="kanban-drop-zone"></div>
            </div>
            <div class="status-column status-concluido">
              <h3>✅ Concluído</h3>
              <div id="kanban-concluido" class="kanban-drop-zone"></div>
            </div>
            <div class="status-column status-cancelado">
              <h3>❌ Cancelado</h3>
              <div id="kanban-cancelado" class="kanban-drop-zone"></div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Modal de Detalhes -->
  <div class="modal" id="detailsModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">📋 Detalhes da Solicitação</h3>
        <button class="close-btn" onclick="closeModal('detailsModal')">&times;</button>
      </div>
      <div id="modalContent">
        <!-- Conteúdo será preenchido dinamicamente -->
      </div>
    </div>
  </div>

  <!-- Modal de Comentário -->
  <div class="modal" id="commentModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">💬 Adicionar Comentário</h3>
        <button class="close-btn" onclick="closeModal('commentModal')">&times;</button>
      </div>
      <div>
        <textarea 
          id="commentText" 
          placeholder="Digite seu comentário administrativo..."
          style="width: 100%; height: 100px; padding: 12px; border: 1px solid #ddd; border-radius: 6px; resize: vertical;"
        ></textarea>
        <div style="margin-top: 15px; text-align: right;">
          <button onclick="closeModal('commentModal')" style="margin-right: 10px; padding: 8px 16px; background: #ccc; border: none; border-radius: 4px; cursor: pointer;">
            Cancelar
          </button>
          <button onclick="submitComment()" style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer;">
            💬 Adicionar Comentário
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  
  <!-- Configurações -->
  <script src="shared/firebase-config.js"></script>
  <script src="shared/github-config.js"></script>
  <script src="shared/firebase-service.js"></script>

  <script>
    // 🔐 CONFIGURAÇÃO DE AUTENTICAÇÃO
    const ADMIN_CONFIG = {
      password: 'senai@admin2024', // ⚠️ ALTERE ESTA SENHA!
      sessionDuration: 24 * 60 * 60 * 1000, // 24 horas
      sessionKey: 'senai_admin_session'
    };

    // 🌟 VARIÁVEIS GLOBAIS
    let firebaseService;
    let currentRequests = [];
    let filteredRequests = [];
    let currentViewMode = 'list'; // 'list' ou 'kanban'
    let currentRequestId = null; // Para modal de comentário

    // 🔒 SISTEMA DE AUTENTICAÇÃO
    class AdminAuth {
      static isAuthenticated() {
        const session = localStorage.getItem(ADMIN_CONFIG.sessionKey);
        if (!session) return false;

        try {
          const data = JSON.parse(session);
          const now = Date.now();
          
          if (now > data.expires) {
            this.logout();
            return false;
          }
          
          return true;
        } catch {
          this.logout();
          return false;
        }
      }

      static login(password) {
        if (password === ADMIN_CONFIG.password) {
          const session = {
            timestamp: Date.now(),
            expires: Date.now() + ADMIN_CONFIG.sessionDuration
          };
          
          localStorage.setItem(ADMIN_CONFIG.sessionKey, JSON.stringify(session));
          return true;
        }
        return false;
      }

      static logout() {
        localStorage.removeItem(ADMIN_CONFIG.sessionKey);
      }
    }

    // 🎨 SISTEMA DE TOAST NOTIFICATIONS
    class ToastManager {
      static show(message, type = 'info', duration = 4000) {
        const toastContainer = document.getElementById('toastContainer');
        
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        
        const icons = {
          success: '✅',
          error: '❌',
          warning: '⚠️',
          info: 'ℹ️'
        };
        
        toast.innerHTML = `
          <span class="toast-icon">${icons[type] || icons.info}</span>
          <span class="toast-message">${message}</span>
          <button class="toast-close" onclick="this.parentElement.remove()">&times;</button>
        `;
        
        toastContainer.appendChild(toast);
        
        // Animar entrada
        setTimeout(() => toast.classList.add('show'), 100);
        
        // Remover automaticamente
        setTimeout(() => {
          toast.classList.remove('show');
          setTimeout(() => toast.remove(), 300);
        }, duration);
      }
    }

    // 🔄 SISTEMA DE LOADING
    class LoadingManager {
      static show(message = 'Carregando...') {
        const overlay = document.getElementById('loadingOverlay');
        const messageEl = document.getElementById('loadingMessage');
        messageEl.textContent = message;
        overlay.style.display = 'flex';
      }

      static hide() {
        const overlay = document.getElementById('loadingOverlay');
        overlay.style.display = 'none';
      }
    }

    // 📊 SISTEMA DE DADOS AVANÇADO
    class DashboardManager {
      static async loadStats() {
        try {
          const requests = await firebaseService.getAllRequests();
          currentRequests = requests;
          
          const stats = {
            total: requests.length,
            pending: requests.filter(r => !r.admin?.status || r.admin.status === 'pendente').length,
            inProgress: requests.filter(r => r.admin?.status === 'em_andamento').length,
            completed: requests.filter(r => r.admin?.status === 'concluido').length,
            cancelled: requests.filter(r => r.admin?.status === 'cancelado').length,
            today: requests.filter(r => {
              const today = new Date();
              const requestDate = new Date(r.d);
              return requestDate.toDateString() === today.toDateString();
            }).length
          };

          return { stats, requests };
        } catch (error) {
          console.error('❌ Erro ao carregar dados:', error);
          ToastManager.show('Erro ao carregar dados: ' + error.message, 'error');
          return { stats: {}, requests: [] };
        }
      }

      static async updateStatus(requestId, newStatus, comment = '') {
        try {
          LoadingManager.show('Atualizando status...');
          
          const success = await firebaseService.updateRequestStatus(requestId, newStatus, {
            comment: comment,
            responsavel: 'Administrador'
          });
          
          if (success) {
            ToastManager.show(`Status atualizado para: ${this.getStatusName(newStatus)}`, 'success');
            await loadDashboard();
          }
          
          LoadingManager.hide();
          return success;
        } catch (error) {
          LoadingManager.hide();
          ToastManager.show('Erro ao atualizar status', 'error');
          return false;
        }
      }

      static async setPriority(requestId, priority) {
        try {
          const success = await firebaseService.setPriority(requestId, priority);
          if (success) {
            ToastManager.show(`Prioridade definida: ${priority.toUpperCase()}`, 'success');
            await loadDashboard();
          }
          return success;
        } catch (error) {
          ToastManager.show('Erro ao definir prioridade', 'error');
          return false;
        }
      }

      static getStatusName(status) {
        const names = {
          'pendente': 'Pendente',
          'em_andamento': 'Em Andamento',
          'concluido': 'Concluído',
          'cancelado': 'Cancelado'
        };
        return names[status] || status;
      }
    }

    // 🎨 SISTEMA DE INTERFACE
    function updateStatsDisplay(stats) {
      document.getElementById('totalRequests').textContent = stats.total || 0;
      document.getElementById('pendingRequests').textContent = stats.pending || 0;
      document.getElementById('inProgressRequests').textContent = stats.inProgress || 0;
      document.getElementById('completedRequests').textContent = stats.completed || 0;

      // Atualizar indicadores de mudança
      document.getElementById('totalChange').textContent = `+${stats.today || 0} hoje`;
      document.getElementById('pendingChange').textContent = stats.pending > 5 ? 'Requer atenção' : 'Sob controle';
      document.getElementById('progressChange').textContent = 'Em processo';
      document.getElementById('completedChange').textContent = 'Finalizadas';
    }

    function formatDate(timestamp) {
      return new Date(timestamp).toLocaleString('pt-BR');
    }

    function getServiceName(service, subService) {
      const names = {
        'espaco_maker': 'Espaço Maker',
        'servicos': {
          'impressao': 'Impressão',
          'impressao_3d': 'Impressão 3D',
          'manutencao': 'Manutenção',
          'arte_digital': 'Arte Digital',
          'projeto': 'Projeto'
        },
        'emprestimo': 'Empréstimo'
      };

      if (service === 'servicos' && subService) {
        return names.servicos[subService] || subService;
      }

      return names[service] || service;
    }

    function getStatusBadge(status) {
      const badges = {
        'pendente': '<span style="background: #ffeaa7; color: #d63031; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;">⏳ Pendente</span>',
        'em_andamento': '<span style="background: #74b9ff; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;">🔄 Em Andamento</span>',
        'concluido': '<span style="background: #00b894; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;">✅ Concluído</span>',
        'cancelado': '<span style="background: #d63031; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;">❌ Cancelado</span>'
      };
      
      return badges[status] || badges['pendente'];
    }

    function getPriorityClass(priority) {
      return priority ? `priority-${priority}` : '';
    }

    // 📋 RENDERIZAÇÃO DA LISTA
    async function renderRequestsList(requests) {
      const container = document.getElementById('requestsList');
      
      if (requests.length === 0) {
        container.innerHTML = '<div class="loading"><p>Nenhuma solicitação encontrada</p></div>';
        return;
      }

      let html = '';
      
      requests.forEach(request => {
        const status = request.admin?.status || 'pendente';
        const priority = request.admin?.prioridade || '';
        const serviceName = getServiceName(request.s, request.ts);
        const priorityClass = getPriorityClass(priority);
        
        html += `
          <div class="request-card ${priorityClass}" onclick="viewDetails('${request.id}')">
            ${priority ? `<div class="priority-indicator priority-${priority}">${priority.toUpperCase()}</div>` : ''}
            
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
              <div style="flex: 1;">
                <h3 style="color: #1e3c72; margin-bottom: 8px; font-size: 1.1rem;">
                  ${serviceName} - ${request.c}
                </h3>
                <p style="color: #666; font-size: 0.9rem; margin-bottom: 5px;">
                  📧 ${request.e} | 📱 ${request.w || 'N/A'}
                </p>
                <p style="color: #888; font-size: 0.8rem;">
                  📅 ${formatDate(request.d)}
                </p>
              </div>
              <div style="text-align: right;">
                ${getStatusBadge(status)}
              </div>
            </div>
            
            <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
              <h4 style="color: #333; font-size: 0.9rem; margin-bottom: 8px;">📋 Detalhes:</h4>
              <div style="font-size: 0.85rem; color: #555;">
                ${formatRequestDetails(request)}
              </div>
              ${request.arq && request.arq.length > 0 ? `
                <div style="margin-top: 10px;">
                  <strong>📎 Arquivos:</strong>
                  ${request.arq.map(arquivo => `
                    <a href="${arquivo.u}" target="_blank" style="display: inline-block; margin: 5px 5px 0 0; padding: 4px 8px; background: #e3f2fd; color: #1976d2; text-decoration: none; border-radius: 4px; font-size: 0.8rem;">
                      📄 ${arquivo.n}
                    </a>
                  `).join('')}
                </div>
              ` : ''}
            </div>

            <div class="quick-actions" onclick="event.stopPropagation();">
              <select onchange="updateStatus('${request.id}', this.value)" class="quick-action" style="margin-right: 8px;">
                <option value="">Status</option>
                <option value="pendente" ${status === 'pendente' ? 'selected' : ''}>⏳ Pendente</option>
                <option value="em_andamento" ${status === 'em_andamento' ? 'selected' : ''}>🔄 Em Andamento</option>
                <option value="concluido" ${status === 'concluido' ? 'selected' : ''}>✅ Concluído</option>
                <option value="cancelado" ${status === 'cancelado' ? 'selected' : ''}>❌ Cancelado</option>
              </select>
              
              <select onchange="setPriority('${request.id}', this.value)" class="quick-action">
                <option value="">Prioridade</option>
                <option value="alta" ${priority === 'alta' ? 'selected' : ''}>🔴 Alta</option>
                <option value="media" ${priority === 'media' ? 'selected' : ''}>🟡 Média</option>
                <option value="baixa" ${priority === 'baixa' ? 'selected' : ''}>🟢 Baixa</option>
              </select>
              
              <button onclick="addComment('${request.id}')" class="quick-action comment">
                💬 Comentar
              </button>
              
              <button onclick="viewDetails('${request.id}')" class="quick-action details">
                👁️ Detalhes
              </button>
            </div>

            ${request.admin?.comentarios && request.admin.comentarios.length > 0 ? `
              <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee;">
                <h4 style="color: #333; font-size: 0.9rem; margin-bottom: 10px;">💬 Comentários (${request.admin.comentarios.length}):</h4>
                ${request.admin.comentarios.slice(-2).map(comment => `
                  <div style="background: #f0f8ff; padding: 10px; margin-bottom: 8px; border-radius: 4px; border-left: 3px solid #2196f3;">
                    <div style="font-size: 0.85rem; color: #555; margin-bottom: 5px;">
                      <strong>${comment.autor}</strong> - ${formatDate(comment.timestamp)}
                    </div>
                    <div style="font-size: 0.9rem; color: #333;">
                      ${comment.texto}
                    </div>
                  </div>
                `).join('')}
                ${request.admin.comentarios.length > 2 ? `
                  <p style="font-size: 0.8rem; color: #666; text-align: center; margin-top: 5px;">
                    +${request.admin.comentarios.length - 2} comentários mais antigos (clique em "Detalhes" para ver todos)
                  </p>
                ` : ''}
              </div>
            ` : ''}
          </div>
        `;
      });

      container.innerHTML = html;
    }

    // 🎯 KANBAN BOARD
    function renderKanbanBoard(requests) {
      const statusColumns = {
        'pendente': document.getElementById('kanban-pendente'),
        'em_andamento': document.getElementById('kanban-em_andamento'),
        'concluido': document.getElementById('kanban-concluido'),
        'cancelado': document.getElementById('kanban-cancelado')
      };

      // Limpar colunas
      Object.values(statusColumns).forEach(column => {
        column.innerHTML = '';
      });

      // Agrupar por status
      const groupedRequests = {};
      requests.forEach(request => {
        const status = request.admin?.status || 'pendente';
        if (!groupedRequests[status]) {
          groupedRequests[status] = [];
        }
        groupedRequests[status].push(request);
      });

      // Renderizar cards em cada coluna
      Object.entries(groupedRequests).forEach(([status, requests]) => {
        const column = statusColumns[status];
        if (!column) return;

        requests.forEach(request => {
          const serviceName = getServiceName(request.s, request.ts);
          const priority = request.admin?.prioridade || '';
          
          const card = document.createElement('div');
          card.className = `kanban-card ${getPriorityClass(priority)}`;
          card.draggable = true;
          card.dataset.requestId = request.id;
          card.dataset.currentStatus = status;
          
          card.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
              <strong style="font-size: 0.9rem; color: #1e3c72;">${serviceName}</strong>
              ${priority ? `<span class="priority-indicator priority-${priority}" style="font-size: 0.7rem;">${priority.toUpperCase()}</span>` : ''}
            </div>
            <p style="font-size: 0.8rem; color: #666; margin-bottom: 8px;">${request.c}</p>
            <p style="font-size: 0.7rem; color: #888;">${formatDate(request.d)}</p>
            <div style="margin-top: 10px;">
              <button onclick="viewDetails('${request.id}')" style="font-size: 0.7rem; padding: 4px 8px; background: #e3f2fd; border: none; border-radius: 3px; cursor: pointer;">
                👁️ Ver
              </button>
              <button onclick="addComment('${request.id}')" style="font-size: 0.7rem; padding: 4px 8px; background: #f3e5f5; border: none; border-radius: 3px; cursor: pointer; margin-left: 5px;">
                💬 +
              </button>
            </div>
          `;

          // Drag and Drop events
          card.addEventListener('dragstart', handleDragStart);
          card.addEventListener('dragend', handleDragEnd);
          
          column.appendChild(card);
        });
      });

      // Setup drop zones
      Object.entries(statusColumns).forEach(([status, column]) => {
        column.addEventListener('dragover', handleDragOver);
        column.addEventListener('drop', (e) => handleDrop(e, status));
      });
    }

    // 🎯 DRAG AND DROP HANDLERS
    function handleDragStart(e) {
      e.dataTransfer.setData('text/plain', e.target.dataset.requestId);
      e.target.classList.add('dragging');
    }

    function handleDragEnd(e) {
      e.target.classList.remove('dragging');
    }

    function handleDragOver(e) {
      e.preventDefault();
    }

    async function handleDrop(e, newStatus) {
      e.preventDefault();
      const requestId = e.dataTransfer.getData('text/plain');
      const card = document.querySelector(`[data-request-id="${requestId}"]`);
      const currentStatus = card.dataset.currentStatus;

      if (currentStatus !== newStatus) {
        await DashboardManager.updateStatus(requestId, newStatus);
      }
    }

    // 🔄 FUNÇÕES DE INTERAÇÃO
    async function updateStatus(requestId, newStatus) {
      if (newStatus) {
        await DashboardManager.updateStatus(requestId, newStatus);
      }
    }

    async function setPriority(requestId, priority) {
      if (priority) {
        await DashboardManager.setPriority(requestId, priority);
      }
    }

    function addComment(requestId) {
      currentRequestId = requestId;
      document.getElementById('commentText').value = '';
      openModal('commentModal');
    }

    async function submitComment() {
      const comment = document.getElementById('commentText').value.trim();
      if (comment && currentRequestId) {
        try {
          LoadingManager.show('Adicionando comentário...');
          const success = await firebaseService.addComment(currentRequestId, comment);
          if (success) {
            ToastManager.show('Comentário adicionado com sucesso!', 'success');
            closeModal('commentModal');
            await loadDashboard();
          }
          LoadingManager.hide();
        } catch (error) {
          LoadingManager.hide();
          ToastManager.show('Erro ao adicionar comentário', 'error');
        }
      }
    }

    function viewDetails(requestId) {
      const request = currentRequests.find(r => r.id === requestId);
      if (!request) return;

      const modalContent = document.getElementById('modalContent');
      const serviceName = getServiceName(request.s, request.ts);
      const status = request.admin?.status || 'pendente';
      const priority = request.admin?.prioridade || 'Não definida';

      modalContent.innerHTML = `
        <div style="margin-bottom: 20px;">
          <h3 style="color: #1e3c72; margin-bottom: 10px;">${serviceName} - ${request.c}</h3>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div>
              <strong>📧 Email:</strong> ${request.e}<br>
              <strong>📱 WhatsApp:</strong> ${request.w || 'N/A'}<br>
              <strong>📅 Data:</strong> ${formatDate(request.d)}
            </div>
            <div>
              <strong>Status:</strong> ${getStatusBadge(status)}<br>
              <strong>🎯 Prioridade:</strong> <span class="priority-${priority.toLowerCase()}">${priority}</span><br>
              <strong>🆔 ID:</strong> ${request.id}
            </div>
          </div>
        </div>

        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
          <h4 style="margin-bottom: 10px;">📋 Detalhes do Serviço:</h4>
          ${formatRequestDetails(request)}
        </div>

        ${request.arq && request.arq.length > 0 ? `
          <div style="margin-bottom: 20px;">
            <h4 style="margin-bottom: 10px;">📎 Arquivos Anexados:</h4>
            ${request.arq.map(arquivo => `
              <div style="display: flex; align-items: center; gap: 10px; padding: 10px; background: #e3f2fd; border-radius: 6px; margin-bottom: 5px;">
                <span>📄</span>
                <div style="flex: 1;">
                  <strong>${arquivo.n}</strong><br>
                  <small style="color: #666;">Tamanho: ${(arquivo.s / 1024).toFixed(1)} KB</small>
                </div>
                <a href="${arquivo.u}" target="_blank" style="padding: 5px 10px; background: #1976d2; color: white; text-decoration: none; border-radius: 4px; font-size: 0.8rem;">
                  Abrir
                </a>
              </div>
            `).join('')}
          </div>
        ` : ''}

        ${request.admin?.comentarios && request.admin.comentarios.length > 0 ? `
          <div>
            <h4 style="margin-bottom: 10px;">💬 Histórico de Comentários:</h4>
            ${request.admin.comentarios.map(comment => `
              <div style="background: #f0f8ff; padding: 15px; margin-bottom: 10px; border-radius: 6px; border-left: 4px solid #2196f3;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                  <strong style="color: #1976d2;">${comment.autor}</strong>
                  <span style="color: #666; font-size: 0.85rem;">${formatDate(comment.timestamp)}</span>
                </div>
                <p style="margin: 0; line-height: 1.4;">${comment.texto}</p>
              </div>
            `).join('')}
          </div>
        ` : '<p style="color: #666; font-style: italic;">Nenhum comentário administrativo.</p>'}

        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; text-align: center;">
          <button onclick="addComment('${request.id}')" style="margin-right: 10px; padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">
            💬 Adicionar Comentário
          </button>
          <button onclick="closeModal('detailsModal')" style="padding: 10px 20px; background: #ccc; border: none; border-radius: 6px; cursor: pointer;">
            Fechar
          </button>
        </div>
      `;

      openModal('detailsModal');
    }

    function formatRequestDetails(request) {
      const service = request.s;
      const dados = request.dados || {};
      
      if (service === 'espaco_maker') {
        return `
          <strong>Data:</strong> ${dados.dr || 'N/A'}<br>
          <strong>Horário:</strong> ${dados.hi || 'N/A'} às ${dados.hf || 'N/A'}<br>
          <strong>Chrome Books:</strong> ${dados.cb ? `Sim (${dados.qcb || 0} unidades)` : 'Não'}<br>
          <strong>Computadores:</strong> ${dados.cp ? `Sim (${dados.qcp || 0} unidades)` : 'Não'}<br>
          <strong>Descrição:</strong> ${dados.desc || 'N/A'}
        `;
      } else if (service === 'servicos') {
        const tipo = request.ts;
        
        if (tipo === 'impressao') {
          return `
            <strong>Tamanho:</strong> ${dados.tf || 'N/A'}<br>
            <strong>Quantidade:</strong> ${dados.qc || 0} cópias<br>
            <strong>Frente e Verso:</strong> ${dados.fv ? 'Sim' : 'Não'}<br>
            <strong>Colorido:</strong> ${dados.co ? 'Sim' : 'Não'}<br>
            <strong>Escanear:</strong> ${dados.es ? 'Sim' : 'Não'}
          `;
        } else if (tipo === 'impressao_3d') {
          return `
            <strong>Material:</strong> ${dados.mt || 'N/A'}<br>
            <strong>Quantidade:</strong> ${dados.qt || 0}<br>
            <strong>Possui STL:</strong> ${dados.stl ? 'Sim' : 'Não'}<br>
            ${dados.dp ? `<strong>Descrição:</strong> ${dados.dp}` : ''}
          `;
        } else if (tipo === 'manutencao') {
          return `<strong>Problema:</strong> ${dados.prob || 'N/A'}`;
        } else if (tipo === 'arte_digital' || tipo === 'projeto') {
          return `<strong>Descrição:</strong> ${dados.desc || 'N/A'}`;
        }
      } else if (service === 'emprestimo') {
        return `
          <strong>Item:</strong> ${dados.ni || 'N/A'}<br>
          <strong>Retirada:</strong> ${dados.dr || 'N/A'}<br>
          <strong>Devolução:</strong> ${dados.dd || 'N/A'}
        `;
      }
      
      return 'Detalhes não disponíveis';
    }

    // 🔍 SISTEMA DE BUSCA E FILTROS
    function applySearchFilter() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      
      if (!searchTerm) {
        filteredRequests = applyFilters(currentRequests);
      } else {
        filteredRequests = currentRequests.filter(request => {
          const searchableText = [
            request.c,
            request.e,
            request.w,
            getServiceName(request.s, request.ts),
            JSON.stringify(request.dados)
          ].join(' ').toLowerCase();
          
          return searchableText.includes(searchTerm);
        });
        
        filteredRequests = applyFilters(filteredRequests);
      }
      
      if (currentViewMode === 'list') {
        renderRequestsList(filteredRequests);
      } else {
        renderKanbanBoard(filteredRequests);
      }
    }

    function applyFilters(requests) {
      const serviceFilter = document.getElementById('filterService').value;
      const statusFilter = document.getElementById('filterStatus').value;
      const priorityFilter = document.getElementById('filterPriority').value;
      const periodFilter = document.getElementById('filterPeriod').value;

      let filtered = requests;

      // Filtro por serviço
      if (serviceFilter) {
        filtered = filtered.filter(r => r.s === serviceFilter);
      }

      // Filtro por status
      if (statusFilter) {
        filtered = filtered.filter(r => {
          const status = r.admin?.status || 'pendente';
          return status === statusFilter;
        });
      }

      // Filtro por prioridade
      if (priorityFilter) {
        filtered = filtered.filter(r => r.admin?.prioridade === priorityFilter);
      }

      // Filtro por período
      if (periodFilter !== 'todos') {
        const now = new Date();
        const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const startOfWeek = new Date(startOfDay);
        startOfWeek.setDate(startOfDay.getDate() - startOfDay.getDay());
        const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);

        filtered = filtered.filter(r => {
          const requestDate = new Date(r.d);
          
          switch (periodFilter) {
            case 'hoje':
              return requestDate >= startOfDay;
            case 'semana':
              return requestDate >= startOfWeek;
            case 'mes':
              return requestDate >= startOfMonth;
            default:
              return true;
          }
        });
      }

      return filtered.sort((a, b) => b.d - a.d); // Ordenar por data (mais recente primeiro)
    }

    // 🎯 CONTROLES DE VISUALIZAÇÃO
    function toggleViewMode() {
      const listView = document.getElementById('listView');
      const kanbanView = document.getElementById('kanbanView');
      const viewModeBtn = document.getElementById('viewModeBtn');

      if (currentViewMode === 'list') {
        currentViewMode = 'kanban';
        listView.style.display = 'none';
        kanbanView.style.display = 'block';
        viewModeBtn.innerHTML = '📋 Alternar para Lista';
        renderKanbanBoard(filteredRequests);
      } else {
        currentViewMode = 'list';
        listView.style.display = 'block';
        kanbanView.style.display = 'none';
        viewModeBtn.innerHTML = '📋 Alternar para Kanban';
        renderRequestsList(filteredRequests);
      }
    }

    function filterByStatus(status) {
      document.getElementById('filterStatus').value = status;
      loadDashboard();
    }

    // 🎛️ MODAIS
    function openModal(modalId) {
      const modal = document.getElementById(modalId);
      modal.classList.add('show');
      document.body.style.overflow = 'hidden';
    }

    function closeModal(modalId) {
      const modal = document.getElementById(modalId);
      modal.classList.remove('show');
      document.body.style.overflow = 'auto';
    }

    // 📊 EXPORTAÇÃO DE DADOS
    function exportToExcel() {
      ToastManager.show('Preparando exportação para Excel...', 'info');
      
      // Criar dados para exportação
      const exportData = filteredRequests.map(request => ({
        'ID': request.id,
        'Data': formatDate(request.d),
        'Colaborador': request.c,
        'Email': request.e,
        'WhatsApp': request.w || '',
        'Serviço': getServiceName(request.s, request.ts),
        'Status': request.admin?.status || 'pendente',
        'Prioridade': request.admin?.prioridade || '',
        'Comentários': request.admin?.comentarios?.length || 0
      }));

      // Converter para CSV (simulação - em produção use uma lib como XLSX)
      const csv = convertToCSV(exportData);
      downloadFile(csv, 'senai-lab-solicitacoes.csv', 'text/csv');
      
      ToastManager.show('Arquivo Excel exportado com sucesso!', 'success');
    }

    function exportToPDF() {
      ToastManager.show('Exportação PDF em desenvolvimento...', 'warning');
      // TODO: Implementar exportação PDF
    }

    function convertToCSV(data) {
      if (!data.length) return '';
      
      const headers = Object.keys(data[0]);
      const csvContent = [
        headers.join(','),
        ...data.map(row => headers.map(header => `"${row[header] || ''}"`).join(','))
      ].join('\n');
      
      return csvContent;
    }

    function downloadFile(content, fileName, mimeType) {
      const blob = new Blob([content], { type: mimeType });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = fileName;
      document.body.appendChild(a);
      a.click();
      window.URL.revokeObjectURL(url);
      document.body.removeChild(a);
    }

    // 🔄 CARREGAMENTO DO DASHBOARD
    async function loadDashboard() {
      try {
        LoadingManager.show('Carregando dados do dashboard...');
        
        const { stats, requests } = await DashboardManager.loadStats();
        
        updateStatsDisplay(stats);
        
        filteredRequests = applyFilters(requests);
        
        if (currentViewMode === 'list') {
          await renderRequestsList(filteredRequests);
        } else {
          renderKanbanBoard(filteredRequests);
        }
        
        LoadingManager.hide();
        ToastManager.show(`Dashboard atualizado! ${filteredRequests.length} solicitações carregadas.`, 'success');
      } catch (error) {
        LoadingManager.hide();
        console.error('❌ Erro ao carregar dashboard:', error);
        ToastManager.show('Erro ao carregar dashboard', 'error');
      }
    }

    // 🔐 SISTEMA DE LOGIN/LOGOUT
    document.getElementById('loginForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const password = document.getElementById('adminPassword').value;
      const loginBtn = document.getElementById('loginBtn');
      const loginText = document.getElementById('loginText');
      const loginLoading = document.getElementById('loginLoading');
      const errorDiv = document.getElementById('loginError');

      // UI de loading
      loginBtn.disabled = true;
      loginText.style.display = 'none';
      loginLoading.style.display = 'inline';
      errorDiv.style.display = 'none';

      // Simular delay de verificação
      setTimeout(() => {
        if (AdminAuth.login(password)) {
          ToastManager.show('Login realizado com sucesso!', 'success');
          showDashboard();
        } else {
          errorDiv.textContent = '❌ Senha incorreta. Tente novamente.';
          errorDiv.style.display = 'block';
          
          // Reset do formulário
          loginBtn.disabled = false;
          loginText.style.display = 'inline';
          loginLoading.style.display = 'none';
          document.getElementById('adminPassword').value = '';
          document.getElementById('adminPassword').focus();
        }
      }, 1000);
    });

    function logout() {
      if (confirm('Tem certeza que deseja sair?')) {
        AdminAuth.logout();
        ToastManager.show('Logout realizado com sucesso!', 'success');
        showLogin();
      }
    }

    function showLogin() {
      document.getElementById('loginContainer').style.display = 'flex';
      document.getElementById('dashboard').classList.remove('show');
      document.getElementById('adminPassword').focus();
    }

    function showDashboard() {
      document.getElementById('loginContainer').style.display = 'none';
      document.getElementById('dashboard').classList.add('show');
      loadDashboard();
    }

    // 📱 EVENT LISTENERS
    document.getElementById('filterService').addEventListener('change', loadDashboard);
    document.getElementById('filterStatus').addEventListener('change', loadDashboard);
    document.getElementById('filterPriority').addEventListener('change', loadDashboard);
    document.getElementById('filterPeriod').addEventListener('change', loadDashboard);

    // Fechar modal clicando fora
    window.addEventListener('click', function(e) {
      if (e.target.classList.contains('modal')) {
        e.target.classList.remove('show');
        document.body.style.overflow = 'auto';
      }
    });

    // ⚡ INICIALIZAÇÃO
    document.addEventListener('DOMContentLoaded', function() {
      console.log('🔧 SENAI Lab - Dashboard Administrativo v2.0 Iniciado');
      
      // Inicializar Firebase Service
      try {
        firebaseService = new FirebaseService();
        console.log('✅ Firebase Service inicializado');
      } catch (error) {
        console.error('❌ Erro ao inicializar Firebase:', error);
        ToastManager.show('Erro ao conectar com Firebase', 'error');
        return;
      }
      
      // Verificar se já está autenticado
      if (AdminAuth.isAuthenticated()) {
        showDashboard();
      } else {
        showLogin();
      }

      // Auto-refresh a cada 30 segundos se estiver autenticado
      setInterval(() => {
        if (AdminAuth.isAuthenticated() && document.getElementById('dashboard').classList.contains('show')) {
          loadDashboard();
        }
      }, 30000);

      // Mostrar toast de boas-vindas
      setTimeout(() => {
        if (AdminAuth.isAuthenticated()) {
          ToastManager.show('Dashboard v2.0 carregado com sucesso! 🚀', 'success');
        }
      }, 1000);
    });

    // ⚠️ AVISO IMPORTANTE
    console.log(`
🔧 SENAI Lab - Dashboard Administrativo v2.0

🆕 NOVIDADES DA VERSÃO 2.0:
    ✅ Toast notifications elegantes
    ✅ Modal de detalhes completos
    ✅ Busca por texto em tempo real
    ✅ Vista Kanban com drag & drop
    ✅ Sistema de prioridades
    ✅ Exportação para Excel
    ✅ Loading states melhorados
    ✅ Interface mais responsiva
    ✅ Comentários expandidos
    ✅ Quick actions nos cards

⚠️  CONFIGURAÇÃO DE SEGURANÇA:
    Altere a senha em ADMIN_CONFIG.password
    Senha atual: "${ADMIN_CONFIG.password}"
    
🎯 Funcionalidades ativas:
    ✅ Autenticação por senha
    ✅ Sessão persistente (24h)
    ✅ Visualização avançada de solicitações
    ✅ Atualização de status e prioridades
    ✅ Sistema de comentários expandido
    ✅ Filtros e busca avançados
    ✅ Auto-refresh (30s)
    ✅ Vista Kanban interativa
    ✅ Exportação de dados

🚀 Próximos passos sugeridos:
    1. Alterar senha de acesso
    2. Testar todas as funcionalidades
    3. Configurar exportação PDF
    4. Implementar notificações por email
    `);
  </script>
</body>
</html>