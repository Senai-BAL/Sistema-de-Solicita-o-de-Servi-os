<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SENAI Lab - Dashboard Administrativo v2</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      min-height: 100vh;
      color: #333;
    }

    /* ===== MODAL STYLES ===== */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(5px);
    }

    .modal.show {
      display: flex;
      justify-content: center;
      align-items: center;
      animation: fadeIn 0.3s ease;
    }

    .modal-content {
      background: white;
      border-radius: 16px;
      padding: 30px;
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
      position: relative;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f1f3f4;
    }

    .modal-title {
      font-size: 1.5rem;
      color: #1e3c72;
      font-weight: 600;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #666;
      padding: 5px;
      border-radius: 50%;
      transition: all 0.3s ease;
    }

    .close-btn:hover {
      background: #f1f3f4;
      color: #333;
    }

    /* ===== TOAST NOTIFICATIONS ===== */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1100;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .toast {
      background: white;
      border-radius: 8px;
      padding: 15px 20px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      min-width: 300px;
      display: flex;
      align-items: center;
      gap: 10px;
      transform: translateX(400px);
      transition: all 0.3s ease;
      border-left: 4px solid #4285f4;
    }

    .toast.show {
      transform: translateX(0);
    }

    .toast.success {
      border-left-color: #27ae60;
    }

    .toast.error {
      border-left-color: #e74c3c;
    }

    .toast.warning {
      border-left-color: #f39c12;
    }

    .toast-icon {
      font-size: 1.2rem;
    }

    .toast-message {
      flex: 1;
      font-weight: 500;
    }

    .toast-close {
      background: none;
      border: none;
      cursor: pointer;
      color: #666;
      font-size: 1.1rem;
    }

    /* ===== SEARCH AND FILTERS ===== */
    .search-container {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      align-items: end;
    }

    .search-box {
      flex: 1;
      min-width: 200px;
    }

    .search-box input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e1e5e9;
      border-radius: 8px;
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    .search-box input:focus {
      outline: none;
      border-color: #4285f4;
      box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.1);
    }

    /* ===== IMPROVED REQUEST CARDS ===== */
    .request-card {
      border: 1px solid #e1e5e9;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 15px;
      background: white;
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    .request-card:hover {
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
      transform: translateY(-2px);
    }

    .request-card.priority-alta {
      border-left: 5px solid #e74c3c;
    }

    .request-card.priority-media {
      border-left: 5px solid #f39c12;
    }

    .request-card.priority-baixa {
      border-left: 5px solid #27ae60;
    }

    .priority-indicator {
      position: absolute;
      top: 15px;
      right: 15px;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .priority-alta {
      background: #fee;
      color: #e74c3c;
    }

    .priority-media {
      background: #fff8e7;
      color: #f39c12;
    }

    .priority-baixa {
      background: #eafaf1;
      color: #27ae60;
    }

    /* ===== DRAG AND DROP STATUS ===== */
    .status-columns {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .status-column {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 20px;
      min-height: 400px;
    }

    .status-column h3 {
      text-align: center;
      margin-bottom: 15px;
      padding: 10px;
      border-radius: 8px;
      font-weight: 600;
    }

    .status-pendente h3 {
      background: #ffeaa7;
      color: #d63031;
    }

    .status-em_andamento h3 {
      background: #74b9ff;
      color: white;
    }

    .status-concluido h3 {
      background: #00b894;
      color: white;
    }

    .status-cancelado h3 {
      background: #d63031;
      color: white;
    }

    .kanban-card {
      background: white;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      cursor: grab;
      transition: all 0.3s ease;
    }

    .kanban-card:hover {
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
    }

    .kanban-card.dragging {
      opacity: 0.5;
      transform: rotate(5deg);
    }

    /* ===== EXPORT BUTTONS ===== */
    .export-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      align-items: center;
    }

    .btn-export {
      background: #27ae60;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.3s ease;
      font-weight: 500;
    }

    .btn-export:hover {
      background: #229954;
      transform: translateY(-1px);
    }

    .btn-export.excel {
      background: #2e7d32;
    }

    .btn-export.pdf {
      background: #d32f2f;
    }

    /* ===== QUICK ACTIONS ===== */
    .quick-actions {
      display: flex;
      gap: 8px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .quick-action {
      padding: 4px 8px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8rem;
      transition: all 0.3s ease;
    }

    .quick-action.priority {
      background: #fff3cd;
      color: #856404;
    }

    .quick-action.comment {
      background: #d1ecf1;
      color: #0c5460;
    }

    .quick-action.details {
      background: #e2e3e5;
      color: #383d41;
    }

    .quick-action:hover {
      transform: scale(1.05);
    }

    /* ===== STATS IMPROVEMENTS ===== */
    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: linear-gradient(45deg, #667eea, #764ba2);
    }

    /* ===== RESPONSIVE IMPROVEMENTS ===== */
    @media (max-width: 768px) {
      .status-columns {
        grid-template-columns: 1fr;
      }
      
      .search-container {
        flex-direction: column;
        gap: 10px;
      }
      
      .export-buttons {
        flex-wrap: wrap;
      }
      
      .modal-content {
        width: 95%;
        padding: 20px;
      }
    }

    /* ===== LOADING IMPROVEMENTS ===== */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.9);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 999;
      backdrop-filter: blur(2px);
    }

    .loading-content {
      text-align: center;
      color: #1e3c72;
    }

    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }

    /* ===== ANIMATIONS ===== */
    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }

    @keyframes slideIn {
      from { transform: translateX(100%); }
      to { transform: translateX(0); }
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* ===== PRESERVE EXISTING STYLES ===== */
    .login-container {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }

    .login-box {
      background: white;
      border-radius: 16px;
      padding: 40px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      width: 100%;
      max-width: 400px;
      text-align: center;
    }

    .login-header h1 {
      color: #1e3c72;
      font-size: 2rem;
      margin-bottom: 10px;
    }

    .login-header p {
      color: #666;
      font-size: 0.9rem;
    }

    .form-group {
      margin-bottom: 20px;
      text-align: left;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
    }

    .form-group input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e1e5e9;
      border-radius: 8px;
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    .form-group input:focus {
      outline: none;
      border-color: #4285f4;
      box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.1);
    }

    .btn {
      background: linear-gradient(45deg, #667eea, #764ba2);
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 100%;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
    }

    .btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    .error-message {
      color: #e74c3c;
      font-size: 0.9rem;
      margin-top: 10px;
      padding: 10px;
      background: #fdf2f2;
      border-radius: 6px;
      border: 1px solid #fecaca;
      display: none;
    }

    .dashboard {
      display: none;
      min-height: 100vh;
      background: #f8f9fa;
    }

    .dashboard.show {
      display: block;
    }

    .navbar {
      background: white;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      padding: 0 20px;
      height: 70px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .navbar-brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .navbar-brand h1 {
      color: #1e3c72;
      font-size: 1.5rem;
    }

    .navbar-user {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .user-info {
      text-align: right;
    }

    .user-name {
      font-weight: 600;
      color: #333;
      font-size: 0.9rem;
    }

    .user-role {
      color: #666;
      font-size: 0.8rem;
    }

    .btn-logout {
      background: #e74c3c;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.3s ease;
    }

    .btn-logout:hover {
      background: #c0392b;
    }

    .main-content {
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 15px;
    }

    .stat-title {
      color: #666;
      font-size: 0.9rem;
      font-weight: 500;
    }

    .stat-icon {
      font-size: 1.5rem;
    }

    .stat-value {
      font-size: 2.2rem;
      font-weight: 700;
      color: #1e3c72;
    }

    .stat-change {
      font-size: 0.8rem;
      margin-top: 5px;
    }

    .stat-change.positive {
      color: #27ae60;
    }

    .stat-change.negative {
      color: #e74c3c;
    }

    .content-section {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f1f3f4;
    }

    .section-title {
      font-size: 1.3rem;
      color: #1e3c72;
      font-weight: 600;
    }

    .filters {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .filter-group label {
      font-size: 0.8rem;
      color: #666;
      font-weight: 500;
    }

    .filter-group select {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 0.9rem;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .spinner {
      display: inline-block;
      width: 30px;
      height: 30px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay" style="display: none;">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <h3>Processando...</h3>
      <p id="loadingMessage">Carregando dados...</p>
    </div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- Tela de Login -->
  <div class="login-container" id="loginContainer">
    <div class="login-box">
      <div class="login-header">
        <h1>üîß SENAI Lab</h1>
        <p>Dashboard Administrativo v2.0</p>
      </div>
      <form id="loginForm">
        <div class="form-group">
          <label for="adminPassword">Senha de Acesso</label>
          <input 
            type="password" 
            id="adminPassword" 
            placeholder="Digite a senha administrativa"
            required
          >
        </div>
        <button type="submit" class="btn" id="loginBtn">
          <span id="loginText">üîê Entrar</span>
          <span id="loginLoading" style="display: none;">‚è≥ Verificando...</span>
        </button>
        <div class="error-message" id="loginError"></div>
      </form>
    </div>
  </div>

  <!-- Dashboard Principal -->
  <div class="dashboard" id="dashboard">
    <!-- Navbar -->
    <nav class="navbar">
      <div class="navbar-brand">
        <span>üîß</span>
        <h1>SENAI Lab - Admin v2.0</h1>
      </div>
      <div class="navbar-user">
        <div class="user-info">
          <div class="user-name">Administrador</div>
          <div class="user-role">Dashboard Avan√ßado</div>
        </div>
        <button class="btn-logout" onclick="logout()">üö™ Sair</button>
      </div>
    </nav>

    <!-- Conte√∫do Principal -->
    <main class="main-content">
      <!-- Cards de Estat√≠sticas -->
      <div class="stats-grid">
        <div class="stat-card" onclick="filterByStatus('')">
          <div class="stat-header">
            <span class="stat-title">Total de Solicita√ß√µes</span>
            <span class="stat-icon">üìã</span>
          </div>
          <div class="stat-value" id="totalRequests">-</div>
          <div class="stat-change positive" id="totalChange">Carregando...</div>
        </div>

        <div class="stat-card" onclick="filterByStatus('pendente')">
          <div class="stat-header">
            <span class="stat-title">Pendentes</span>
            <span class="stat-icon">‚è≥</span>
          </div>
          <div class="stat-value" id="pendingRequests">-</div>
          <div class="stat-change" id="pendingChange">Carregando...</div>
        </div>

        <div class="stat-card" onclick="filterByStatus('em_andamento')">
          <div class="stat-header">
            <span class="stat-title">Em Andamento</span>
            <span class="stat-icon">üîÑ</span>
          </div>
          <div class="stat-value" id="inProgressRequests">-</div>
          <div class="stat-change" id="progressChange">Carregando...</div>
        </div>

        <div class="stat-card" onclick="filterByStatus('concluido')">
          <div class="stat-header">
            <span class="stat-title">Conclu√≠das</span>
            <span class="stat-icon">‚úÖ</span>
          </div>
          <div class="stat-value" id="completedRequests">-</div>
          <div class="stat-change positive" id="completedChange">Carregando...</div>
        </div>
      </div>

      <!-- Se√ß√£o de Solicita√ß√µes -->
      <div class="content-section">
        <div class="section-header">
          <h2 class="section-title">üìã Gest√£o de Solicita√ß√µes</h2>
          <div class="export-buttons">
            <button class="btn-export excel" onclick="exportToExcel()">üìä Excel</button>
            <button class="btn-export pdf" onclick="exportToPDF()">üìÑ PDF</button>
          </div>
        </div>

        <!-- Busca e Filtros Avan√ßados -->
        <div class="search-container">
          <div class="search-box">
            <input 
              type="text" 
              id="searchInput" 
              placeholder="üîç Buscar por nome, email, descri√ß√£o..."
              oninput="applySearchFilter()"
            >
          </div>
          
          <div class="filter-group">
            <label>Tipo de Servi√ßo</label>
            <select id="filterService" onchange="loadDashboard()">
              <option value="">Todos os tipos</option>
              <option value="espaco_maker">Espa√ßo Maker</option>
              <option value="servicos">Servi√ßos</option>
              <option value="emprestimo">Empr√©stimo</option>
            </select>
          </div>
          
          <div class="filter-group">
            <label>Status</label>
            <select id="filterStatus" onchange="loadDashboard()">
              <option value="">Todos os status</option>
              <option value="pendente">Pendente</option>
              <option value="em_andamento">Em Andamento</option>
              <option value="concluido">Conclu√≠do</option>
              <option value="cancelado">Cancelado</option>
            </select>
          </div>

          <div class="filter-group">
            <label>Prioridade</label>
            <select id="filterPriority" onchange="loadDashboard()">
              <option value="">Todas as prioridades</option>
              <option value="alta">Alta</option>
              <option value="media">M√©dia</option>
              <option value="baixa">Baixa</option>
            </select>
          </div>

          <div class="filter-group">
            <label>Per√≠odo</label>
            <select id="filterPeriod" onchange="loadDashboard()">
              <option value="hoje">Hoje</option>
              <option value="semana">Esta Semana</option>
              <option value="mes">Este M√™s</option>
              <option value="todos">Todos</option>
            </select>
          </div>
        </div>

        <!-- Toggle View Mode -->
        <div style="margin-bottom: 20px;">
          <button 
            id="viewModeBtn" 
            onclick="toggleViewMode()" 
            style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;"
          >
            üìã Alternar para Kanban
          </button>
        </div>

        <!-- Lista de Solicita√ß√µes (Modo Lista) -->
        <div id="listView">
          <div id="requestsList">
            <div class="loading">
              <div class="spinner"></div>
              <p>Carregando solicita√ß√µes...</p>
            </div>
          </div>
        </div>

        <!-- Kanban Board (Modo Kanban) -->
        <div id="kanbanView" style="display: none;">
          <div class="status-columns">
            <div class="status-column status-pendente">
              <h3>‚è≥ Pendente</h3>
              <div id="kanban-pendente" class="kanban-drop-zone"></div>
            </div>
            <div class="status-column status-em_andamento">
              <h3>üîÑ Em Andamento</h3>
              <div id="kanban-em_andamento" class="kanban-drop-zone"></div>
            </div>
            <div class="status-column status-concluido">
              <h3>‚úÖ Conclu√≠do</h3>
              <div id="kanban-concluido" class="kanban-drop-zone"></div>
            </div>
            <div class="status-column status-cancelado">
              <h3>‚ùå Cancelado</h3>
              <div id="kanban-cancelado" class="kanban-drop-zone"></div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Modal de Detalhes -->
  <div class="modal" id="detailsModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">üìã Detalhes da Solicita√ß√£o</h3>
        <button class="close-btn" onclick="closeModal('detailsModal')">&times;</button>
      </div>
      <div id="modalContent">
        <!-- Conte√∫do ser√° preenchido dinamicamente -->
      </div>
    </div>
  </div>

  <!-- Modal de Coment√°rio -->
  <div class="modal" id="commentModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">üí¨ Adicionar Coment√°rio</h3>
        <button class="close-btn" onclick="closeModal('commentModal')">&times;</button>
      </div>
      <div>
        <textarea 
          id="commentText" 
          placeholder="Digite seu coment√°rio administrativo..."
          style="width: 100%; height: 100px; padding: 12px; border: 1px solid #ddd; border-radius: 6px; resize: vertical;"
        ></textarea>
        <div style="margin-top: 15px; text-align: right;">
          <button onclick="closeModal('commentModal')" style="margin-right: 10px; padding: 8px 16px; background: #ccc; border: none; border-radius: 4px; cursor: pointer;">
            Cancelar
          </button>
          <button onclick="submitComment()" style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer;">
            üí¨ Adicionar Coment√°rio
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  
  <!-- Configura√ß√µes -->
  <script src="shared/firebase-config.js"></script>
  <script src="shared/github-config.js"></script>
  <script src="shared/firebase-service.js"></script>

  <script>
    // üîê CONFIGURA√á√ÉO DE AUTENTICA√á√ÉO
    const ADMIN_CONFIG = {
      password: 'senai@admin2025', // ‚ö†Ô∏è ALTERE ESTA SENHA!
      sessionDuration: 24 * 60 * 60 * 1000, // 24 horas
      sessionKey: 'senai_admin_session'
    };

    // üåü VARI√ÅVEIS GLOBAIS
    let firebaseService;
    let currentRequests = [];
    let filteredRequests = [];
    let currentViewMode = 'list'; // 'list' ou 'kanban'
    let currentRequestId = null; // Para modal de coment√°rio
    let dashboardNotifications = null; // Para sistema de notifica√ß√µes

    // üîî SISTEMA DE NOTIFICA√á√ïES EM TEMPO REAL
    class NotificationManager {
      constructor() {
        this.hasPermission = false;
        this.lastKnownRequestsCount = 0;
        this.unsubscribeListener = null;
        this.isListening = false;
        this.seenRequestIds = new Set();
        
        this.init();
      }

      // üîß INICIALIZA√á√ÉO
      async init() {
        await this.requestPermission();
        this.loadSeenRequests();
      }

      // üîê SOLICITAR PERMISS√ÉO PARA NOTIFICA√á√ïES
      async requestPermission() {
        try {
          if ('Notification' in window) {
            const permission = await Notification.requestPermission();
            this.hasPermission = permission === 'granted';
            
            if (this.hasPermission) {
              console.log('‚úÖ Permiss√£o para notifica√ß√µes concedida');
              ToastManager.show('Notifica√ß√µes ativadas! Voc√™ ser√° avisado sobre novas solicita√ß√µes.', 'success');
            } else {
              console.log('‚ùå Permiss√£o para notifica√ß√µes negada');
              ToastManager.show('Permiss√£o para notifica√ß√µes negada. Ative nas configura√ß√µes do navegador.', 'warning');
            }
          } else {
            console.log('‚ùå Navegador n√£o suporta notifica√ß√µes');
            ToastManager.show('Seu navegador n√£o suporta notifica√ß√µes desktop.', 'warning');
          }
        } catch (error) {
          console.error('‚ùå Erro ao solicitar permiss√£o:', error);
        }

        return this.hasPermission;
      }

      // üíæ GERENCIAR SOLICITA√á√ïES J√Å VISTAS
      loadSeenRequests() {
        try {
          const seen = localStorage.getItem('senai_seen_requests');
          if (seen) {
            this.seenRequestIds = new Set(JSON.parse(seen));
          }
        } catch (error) {
          console.warn('Erro ao carregar solicita√ß√µes vistas:', error);
        }
      }

      saveSeenRequests() {
        try {
          localStorage.setItem('senai_seen_requests', JSON.stringify([...this.seenRequestIds]));
        } catch (error) {
          console.warn('Erro ao salvar solicita√ß√µes vistas:', error);
        }
      }

      markAsSeen(requestId) {
        this.seenRequestIds.add(requestId);
        this.saveSeenRequests();
      }

      // üîÑ INICIAR MONITORAMENTO EM TEMPO REAL
      startListening() {
        if (this.isListening || !this.hasPermission || !firebaseService) {
          return;
        }

        console.log('üîî Iniciando monitoramento de notifica√ß√µes...');
        this.isListening = true;

        try {
          // Listener em tempo real do Firestore
          this.unsubscribeListener = firebaseService.onRequestsChange((requests) => {
            this.checkForNewRequests(requests);
          });

          ToastManager.show('Monitor de notifica√ß√µes ativo! üîî', 'info');
        } catch (error) {
          console.error('‚ùå Erro ao iniciar listener:', error);
          this.isListening = false;
        }
      }

      // üõë PARAR MONITORAMENTO
      stopListening() {
        if (this.unsubscribeListener) {
          this.unsubscribeListener();
          this.unsubscribeListener = null;
        }
        this.isListening = false;
        console.log('üîî Monitoramento de notifica√ß√µes parado');
      }

      // üîç VERIFICAR NOVAS SOLICITA√á√ïES
      checkForNewRequests(requests) {
        if (!Array.isArray(requests)) return;

        // Primeira execu√ß√£o - marcar todas como vistas para n√£o spammar
        if (this.lastKnownRequestsCount === 0) {
          this.lastKnownRequestsCount = requests.length;
          requests.forEach(request => this.markAsSeen(request.id));
          return;
        }

        // Verificar se h√° novas solicita√ß√µes
        const newRequests = requests.filter(request => {
          // Considerar nova se:
          // 1. N√£o foi vista antes E
          // 2. Foi criada recentemente (√∫ltimos 5 minutos)
          const isNotSeen = !this.seenRequestIds.has(request.id);
          const isRecent = Date.now() - request.d < 5 * 60 * 1000; // 5 minutos
          
          return isNotSeen && isRecent;
        });

        // Mostrar notifica√ß√µes para novas solicita√ß√µes
        newRequests.forEach(request => {
          this.showNotification(request);
          this.markAsSeen(request.id);
        });

        // Atualizar contador
        this.lastKnownRequestsCount = requests.length;
      }

      // üîî MOSTRAR NOTIFICA√á√ÉO
      showNotification(request) {
        if (!this.hasPermission) return;

        try {
          const serviceName = this.getServiceName(request.s, request.ts);
          const title = `üîß Nova Solicita√ß√£o SENAI Lab`;
          const body = `${serviceName} - ${request.c}\nüìß ${request.e}`;
          
          const notification = new Notification(title, {
            body: body,
            icon: this.getNotificationIcon(request.s),
            badge: '/favicon.ico',
            tag: `senai-request-${request.id}`, // Evita duplicatas
            requireInteraction: true, // N√£o some automaticamente
            data: {
              requestId: request.id,
              url: window.location.href
            }
          });

          // Eventos da notifica√ß√£o
          notification.onclick = () => {
            // Focar na aba e mostrar detalhes da solicita√ß√£o
            window.focus();
            setTimeout(() => {
              viewDetails(request.id);
            }, 500);
            notification.close();
          };

          notification.onerror = (error) => {
            console.error('‚ùå Erro na notifica√ß√£o:', error);
          };

          // Auto-close ap√≥s 10 segundos se n√£o interagir
          setTimeout(() => {
            notification.close();
          }, 10000);

          // Log para debug
          console.log(`üîî Notifica√ß√£o enviada: ${serviceName} - ${request.c}`);

          // Toast interno tamb√©m
          ToastManager.show(`Nova solicita√ß√£o: ${serviceName} - ${request.c}`, 'info', 6000);

        } catch (error) {
          console.error('‚ùå Erro ao mostrar notifica√ß√£o:', error);
        }
      }

      // üé® √çCONE DA NOTIFICA√á√ÉO BASEADO NO SERVI√áO
      getNotificationIcon(serviceType) {
        // Retorna data URL de √≠cones simples ou emoji como fallback
        const icons = {
          'espaco_maker': 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">üèóÔ∏è</text></svg>',
          'servicos': 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">üñ®Ô∏è</text></svg>',
          'emprestimo': 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">üì¶</text></svg>'
        };
        
        return icons[serviceType] || 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">üîß</text></svg>';
      }

      // üè∑Ô∏è NOME DO SERVI√áO
      getServiceName(service, subService) {
        const names = {
          'espaco_maker': 'Espa√ßo Maker',
          'servicos': {
            'impressao': 'Impress√£o',
            'impressao_3d': 'Impress√£o 3D',
            'manutencao': 'Manuten√ß√£o',
            'arte_digital': 'Arte Digital',
            'projeto': 'Projeto'
          },
          'emprestimo': 'Empr√©stimo'
        };

        if (service === 'servicos' && subService) {
          return names.servicos[subService] || subService;
        }

        return names[service] || service;
      }

      // üìä STATUS DAS NOTIFICA√á√ïES
      getStatus() {
        return {
          hasPermission: this.hasPermission,
          isListening: this.isListening,
          seenCount: this.seenRequestIds.size,
          lastCount: this.lastKnownRequestsCount
        };
      }

      // üßπ LIMPAR DADOS
      clearSeenRequests() {
        this.seenRequestIds.clear();
        this.saveSeenRequests();
        ToastManager.show('Hist√≥rico de notifica√ß√µes limpo', 'info');
      }

      // üîÑ REINICIAR SISTEMA
      restart() {
        this.stopListening();
        this.clearSeenRequests();
        setTimeout(() => {
          this.startListening();
        }, 1000);
      }
    }

    // üåü INTEGRA√á√ÉO COM O DASHBOARD
    class DashboardWithNotifications {
      constructor() {
        this.notificationManager = new NotificationManager();
      }

      // üîê INICIAR QUANDO ADMIN FIZER LOGIN
      async onAdminLogin() {
        console.log('üîî Admin logado - ativando notifica√ß√µes...');
        
        // Aguardar um pouco para garantir que o Firebase est√° pronto
        setTimeout(async () => {
          const hasPermission = await this.notificationManager.requestPermission();
          
          if (hasPermission) {
            this.notificationManager.startListening();
            
            // Mostrar status na interface
            this.updateNotificationStatus(true);
          }
        }, 2000);
      }

      // üö™ PARAR QUANDO ADMIN FIZER LOGOUT
      onAdminLogout() {
        console.log('üîî Admin deslogado - parando notifica√ß√µes...');
        this.notificationManager.stopListening();
        this.updateNotificationStatus(false);
      }

      // üé® ATUALIZAR STATUS NA INTERFACE
      updateNotificationStatus(isActive) {
        // Adicionar indicador visual no navbar
        const navbar = document.querySelector('.navbar-user');
        let indicator = document.getElementById('notificationIndicator');
        
        if (!indicator) {
          indicator = document.createElement('div');
          indicator.id = 'notificationIndicator';
          indicator.style.cssText = `
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 500;
            margin-right: 10px;
          `;
          navbar.insertBefore(indicator, navbar.firstChild);
        }

        if (isActive) {
          indicator.innerHTML = 'üîî Notifica√ß√µes Ativas';
          indicator.style.background = '#e8f5e8';
          indicator.style.color = '#2e7d32';
          indicator.title = 'Voc√™ ser√° notificado sobre novas solicita√ß√µes';
        } else {
          indicator.innerHTML = 'üîï Notifica√ß√µes Inativas';
          indicator.style.background = '#ffeaa7';
          indicator.style.color = '#d63031';
          indicator.title = 'Notifica√ß√µes desativadas';
        }
      }
    }

    // üóÇÔ∏è SISTEMA DE BACKUP COMPLETO + LIMPEZA GITHUB
    class CompleteBackupManager {
      constructor(firebaseService) {
        this.firebaseService = firebaseService;
        this.githubConfig = window.githubConfig;
        this.isProcessing = false;
      }

      // üöÄ BACKUP COMPLETO + LIMPEZA TOTAL
      async createCompleteBackup() {
        if (this.isProcessing) {
          ToastManager.show('Backup j√° est√° em andamento...', 'warning');
          return;
        }

        try {
          this.isProcessing = true;
          LoadingManager.show('üöÄ Iniciando backup completo...');

          // 1. Coletar dados do Firestore
          LoadingManager.show('üìä Coletando dados do Firestore...');
          const firestoreData = await this.collectFirestoreData();

          // 2. Mapear todos os arquivos do GitHub
          LoadingManager.show('üîç Mapeando arquivos do GitHub...');
          const githubFilesList = await this.mapGitHubFiles(firestoreData.requests);

          // 3. Baixar TODOS os arquivos do GitHub
          LoadingManager.show('üì• Baixando arquivos do GitHub...');
          const downloadedFiles = await this.downloadAllGitHubFiles(githubFilesList);

          // 4. Gerar backup completo
          LoadingManager.show('üì¶ Gerando backup completo...');
          const backupPackage = await this.generateCompleteBackup(firestoreData, downloadedFiles);

          // 5. Baixar backup como ZIP
          LoadingManager.show('üíæ Baixando backup...');
          await this.downloadBackupFiles(backupPackage);

          LoadingManager.hide();
          ToastManager.show(`üéâ Backup COMPLETO baixado! ${downloadedFiles.length} arquivos inclu√≠dos.`, 'success');

          // 6. Confirmar limpeza total
          this.confirmTotalCleanup(firestoreData.requests.length, downloadedFiles.length);

        } catch (error) {
          console.error('‚ùå Erro no backup completo:', error);
          LoadingManager.hide();
          ToastManager.show('Erro no backup: ' + error.message, 'error');
        } finally {
          this.isProcessing = false;
        }
      }

      // üìä COLETAR DADOS DO FIRESTORE
      async collectFirestoreData() {
        const requests = await this.firebaseService.getAllRequests();
        
        let adminLogs = [];
        try {
          adminLogs = await this.firebaseService.getAdminLogs();
        } catch (error) {
          console.warn('Logs administrativos n√£o encontrados:', error);
        }

        const stats = this.calculateDetailedStats(requests);

        return {
          requests,
          adminLogs,
          stats,
          backupInfo: {
            timestamp: Date.now(),
            date: new Date().toLocaleString('pt-BR'),
            totalRequests: requests.length,
            totalLogs: adminLogs.length,
            version: '2.0',
            includesGitHubFiles: true,
            backupType: 'COMPLETE_WITH_CLEANUP'
          }
        };
      }

      // üîç MAPEAR ARQUIVOS DO GITHUB
      async mapGitHubFiles(requests) {
        const fileMap = new Map();
        
        requests.forEach(request => {
          if (request.arq && request.arq.length > 0) {
            request.arq.forEach(arquivo => {
              if (!fileMap.has(arquivo.p)) { // p = path no GitHub
                fileMap.set(arquivo.p, {
                  path: arquivo.p,
                  url: arquivo.u,
                  name: arquivo.n,
                  size: arquivo.s,
                  type: arquivo.t,
                  requestInfo: {
                    id: request.id,
                    colaborador: request.c,
                    servico: this.getServiceName(request.s, request.ts),
                    data: new Date(request.d).toLocaleString('pt-BR')
                  }
                });
              }
            });
          }
        });

        return Array.from(fileMap.values());
      }

      // üì• BAIXAR TODOS OS ARQUIVOS DO GITHUB
      async downloadAllGitHubFiles(filesList) {
        if (filesList.length === 0) {
          console.log('üîç Nenhum arquivo para baixar do GitHub');
          return [];
        }

        const downloadedFiles = [];
        const batchSize = 3; // Baixar 3 por vez para n√£o sobrecarregar

        for (let i = 0; i < filesList.length; i += batchSize) {
          const batch = filesList.slice(i, i + batchSize);
          
          LoadingManager.show(`üì• Baixando lote ${Math.floor(i/batchSize) + 1}/${Math.ceil(filesList.length/batchSize)} (${batch.length} arquivos)`);

          const batchPromises = batch.map(async (fileInfo) => {
            try {
              const response = await fetch(fileInfo.url);
              if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
              }
              
              const arrayBuffer = await response.arrayBuffer();
              
              return {
                ...fileInfo,
                content: arrayBuffer,
                downloaded: true,
                downloadDate: new Date().toISOString(),
                sizeBytes: arrayBuffer.byteLength
              };
              
            } catch (error) {
              console.warn(`‚ùå Falha ao baixar ${fileInfo.name}:`, error);
              return {
                ...fileInfo,
                content: null,
                downloaded: false,
                error: error.message
              };
            }
          });

          const batchResults = await Promise.all(batchPromises);
          downloadedFiles.push(...batchResults);

          // Pequena pausa entre lotes
          await new Promise(resolve => setTimeout(resolve, 500));
        }

        const successCount = downloadedFiles.filter(f => f.downloaded).length;
        console.log(`üì• Download conclu√≠do: ${successCount}/${filesList.length} arquivos`);

        return downloadedFiles;
      }

      // üì¶ GERAR BACKUP COMPLETO
      async generateCompleteBackup(firestoreData, downloadedFiles) {
        const { requests, adminLogs, stats, backupInfo } = firestoreData;
        
        const backupPackage = {
          // 1. Informa√ß√µes do backup
          'backup_info.json': JSON.stringify(backupInfo, null, 2),

          // 2. Dados principais
          'dados_completos.json': JSON.stringify({
            solicitacoes: requests,
            logs_administrativos: adminLogs,
            estatisticas: stats,
            backup_info: backupInfo
          }, null, 2),

          // 3. CSV de solicita√ß√µes
          'solicitacoes_todas.csv': this.generateCSV(requests, 'all'),

          // 4. Estat√≠sticas detalhadas
          'estatisticas_detalhadas.json': JSON.stringify(stats, null, 2),

          // 5. Resumo executivo
          'resumo_executivo.txt': this.generateExecutiveSummary(firestoreData, downloadedFiles),

          // 6. Lista de arquivos baixados
          'arquivos_baixados.json': JSON.stringify(downloadedFiles.map(f => ({
            nome: f.name,
            path_original: f.path,
            tamanho: f.sizeBytes,
            tipo: f.type,
            baixado_com_sucesso: f.downloaded,
            data_download: f.downloadDate,
            erro: f.error || null,
            solicitacao: f.requestInfo
          })), null, 2)
        };

        // 7. CSVs por tipo de servi√ßo
        const byService = this.groupRequestsByService(requests);
        Object.entries(byService).forEach(([service, serviceRequests]) => {
          if (serviceRequests.length > 0) {
            const serviceName = this.getServiceDisplayName(service);
            backupPackage[`${serviceName.replace(/\s+/g, '_').toLowerCase()}.csv`] = 
              this.generateCSV(serviceRequests, service);
          }
        });

        // 8. Adicionar arquivos baixados do GitHub
        downloadedFiles.forEach((file, index) => {
          if (file.downloaded && file.content) {
            // Organizar por pasta original
            const folder = this.getFolderFromPath(file.path);
            const fileName = `arquivos_github/${folder}/${file.name}`;
            backupPackage[fileName] = file.content;
          }
        });

        return backupPackage;
      }

      // üíæ BAIXAR ARQUIVOS DE BACKUP
      async downloadBackupFiles(backupPackage) {
        const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
        
        // Baixar arquivo principal JSON
        const mainBackup = backupPackage['dados_completos.json'];
        this.downloadBlob(
          new Blob([mainBackup], { type: 'application/json' }),
          `SENAI_Lab_Backup_Completo_${timestamp}.json`
        );

        // Baixar CSV de solicita√ß√µes
        const csvBackup = backupPackage['solicitacoes_todas.csv'];
        this.downloadBlob(
          new Blob([csvBackup], { type: 'text/csv' }),
          `SENAI_Lab_Solicitacoes_${timestamp}.csv`
        );

        // Baixar resumo executivo
        const resumo = backupPackage['resumo_executivo.txt'];
        this.downloadBlob(
          new Blob([resumo], { type: 'text/plain' }),
          `SENAI_Lab_Resumo_${timestamp}.txt`
        );

        // Baixar lista de arquivos
        const arquivos = backupPackage['arquivos_baixados.json'];
        this.downloadBlob(
          new Blob([arquivos], { type: 'application/json' }),
          `SENAI_Lab_Arquivos_${timestamp}.json`
        );

        // Baixar arquivos individuais do GitHub (se n√£o forem muitos)
        const githubFiles = Object.entries(backupPackage).filter(([key]) => key.startsWith('arquivos_github/'));
        
        if (githubFiles.length > 0 && githubFiles.length <= 10) {
          githubFiles.forEach(([fileName, content]) => {
            const cleanFileName = fileName.replace('arquivos_github/', '').replace(/\//g, '_');
            this.downloadBlob(
              new Blob([content]),
              `GitHub_${cleanFileName}`
            );
          });
        }

        ToastManager.show(`üì• ${4 + Math.min(githubFiles.length, 10)} arquivos baixados!`, 'success');
      }

      // ‚ö†Ô∏è CONFIRMAR LIMPEZA TOTAL
      confirmTotalCleanup(totalRequests, totalFiles) {
        const confirmMessage = `
üóÇÔ∏è BACKUP COMPLETO FINALIZADO!

üìä Backup inclui:
‚Ä¢ ${totalRequests} solicita√ß√µes do Firestore
‚Ä¢ ${totalFiles} arquivos baixados do GitHub
‚Ä¢ Dados salvos em m√∫ltiplos formatos
‚Ä¢ Estat√≠sticas detalhadas

üßπ LIMPEZA TOTAL DO SISTEMA
Para manter o projeto 100% GRATUITO, deseja:

‚úÖ APAGAR TUDO:
‚Ä¢ Todas as solicita√ß√µes do Firestore
‚Ä¢ Todos os arquivos do GitHub
‚Ä¢ Todos os logs administrativos
‚Ä¢ Sistema volta ao estado inicial

üí∞ RESULTADO:
‚Ä¢ Custo: R$ 0,00 (zero storage usado)
‚Ä¢ Performance m√°xima
‚Ä¢ Dados seguros no backup local

‚ö†Ô∏è ATEN√á√ÉO:
Esta a√ß√£o √© IRREVERS√çVEL!
Certifique-se de que o backup foi baixado corretamente.

Deseja prosseguir com a LIMPEZA TOTAL?`;

        if (confirm(confirmMessage)) {
          this.performTotalCleanup();
        } else {
          ToastManager.show('‚úÖ Backup salvo. Sistema mantido como est√°.', 'info');
        }
      }

      // üßπ EXECUTAR LIMPEZA TOTAL
      async performTotalCleanup() {
        try {
          LoadingManager.show('üßπ Iniciando limpeza total...');

          // 1. Mapear arquivos para deletar do GitHub
          LoadingManager.show('üóÇÔ∏è Mapeando arquivos do GitHub...');
          const requests = await this.firebaseService.getAllRequests();
          const githubFiles = await this.mapGitHubFiles(requests);

          console.log(`üìä Estat√≠sticas da limpeza:`);
          console.log(`üìã Solicita√ß√µes no Firestore: ${requests.length}`);
          console.log(`üìÅ Arquivos no GitHub: ${githubFiles.length}`);

          let githubResult = { deleted: 0, errors: 0, total: 0 };

          // 2. Deletar arquivos do GitHub
          if (githubFiles.length > 0) {
            LoadingManager.show(`üóëÔ∏è Iniciando limpeza GitHub: ${githubFiles.length} arquivos...`);
            githubResult = await this.deleteGitHubFiles(githubFiles);
            
            // Mostrar resultado da limpeza GitHub
            if (githubResult.deleted > 0) {
              ToastManager.show(`üóëÔ∏è GitHub: ${githubResult.deleted}/${githubResult.total} arquivos removidos`, 'success');
            }
            if (githubResult.errors > 0) {
              ToastManager.show(`‚ö†Ô∏è GitHub: ${githubResult.errors} arquivos com erro`, 'warning');
            }
          } else {
            console.log('üìÇ Nenhum arquivo encontrado no GitHub para deletar');
          }

          // 3. Limpar Firestore
          LoadingManager.show('üóëÔ∏è Limpando Firestore...');
          await this.cleanFirestore(requests);
          
          if (requests.length > 0) {
            ToastManager.show(`üóëÔ∏è Firestore: ${requests.length} solicita√ß√µes removidas`, 'success');
          }

          // 4. Limpar cache local
          LoadingManager.show('üßπ Limpando cache local...');
          this.cleanLocalCache();

          LoadingManager.hide();
          
          // 5. Mostrar resultado final
          const totalCleaned = githubResult.deleted + requests.length;
          ToastManager.show(`üéâ LIMPEZA TOTAL CONCLU√çDA!`, 'success');
          ToastManager.show(`üìä Removido: ${requests.length} registros Firestore + ${githubResult.deleted} arquivos GitHub`, 'info');
          ToastManager.show(`üí∞ Sistema 100% limpo e gratuito!`, 'success');

          // 6. Recarregar dashboard
          setTimeout(() => {
            loadDashboard();
            ToastManager.show('‚ú® Sistema reiniciado - pronto para novos dados!', 'info');
          }, 4000);

        } catch (error) {
          LoadingManager.hide();
          console.error('‚ùå Erro na limpeza total:', error);
          ToastManager.show('Erro na limpeza: ' + error.message, 'error');
        }
      }

      // üóëÔ∏è DELETAR ARQUIVOS DO GITHUB
      async deleteGitHubFiles(githubFiles) {
        if (!this.githubConfig) {
          console.warn('‚ö†Ô∏è GitHub config n√£o encontrada, pulando limpeza do GitHub');
          return;
        }

        if (githubFiles.length === 0) {
          console.log('üìÇ Nenhum arquivo para deletar no GitHub');
          return;
        }

        console.log(`üóëÔ∏è Iniciando limpeza total do GitHub: ${githubFiles.length} arquivos`);
        
        const batchSize = 3; // Processar 3 arquivos por vez
        let deletedCount = 0;
        let errorCount = 0;

        for (let i = 0; i < githubFiles.length; i += batchSize) {
          const batch = githubFiles.slice(i, i + batchSize);
          const batchNumber = Math.floor(i/batchSize) + 1;
          const totalBatches = Math.ceil(githubFiles.length/batchSize);
          
          LoadingManager.show(`üóëÔ∏è Limpeza GitHub - Lote ${batchNumber}/${totalBatches} (${deletedCount}/${githubFiles.length} conclu√≠dos)`);

          const deletePromises = batch.map(async (file) => {
            try {
              console.log(`üîç Processando: ${file.path}`);
              
              // Primeiro, obter o SHA do arquivo (necess√°rio para deletar)
              const getResponse = await fetch(
                `https://api.github.com/repos/${this.githubConfig.username}/${this.githubConfig.repo}/contents/${file.path}`,
                {
                  headers: {
                    'Authorization': `token ${this.githubConfig.token}`,
                    'Accept': 'application/vnd.github.v3+json'
                  }
                }
              );

              if (!getResponse.ok) {
                if (getResponse.status === 404) {
                  console.warn(`‚ö†Ô∏è Arquivo ${file.path} n√£o encontrado no GitHub (j√° deletado?)`);
                  return { success: false, reason: 'not_found' };
                }
                console.warn(`‚ùå Erro ao buscar ${file.path}: ${getResponse.status}`);
                return { success: false, reason: 'fetch_error' };
              }

              const fileInfo = await getResponse.json();

              // Deletar o arquivo
              const deleteResponse = await fetch(
                `https://api.github.com/repos/${this.githubConfig.username}/${this.githubConfig.repo}/contents/${file.path}`,
                {
                  method: 'DELETE',
                  headers: {
                    'Authorization': `token ${this.githubConfig.token}`,
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({
                    message: `üßπ Limpeza autom√°tica SENAI Lab: ${file.name}`,
                    sha: fileInfo.sha
                  })
                }
              );

              if (deleteResponse.ok) {
                console.log(`‚úÖ Deletado com sucesso: ${file.path}`);
                return { success: true, file: file.path };
              } else {
                console.warn(`‚ùå Falha ao deletar: ${file.path} (${deleteResponse.status})`);
                return { success: false, reason: 'delete_error' };
              }

            } catch (error) {
              console.error(`‚ùå Erro ao processar ${file.path}:`, error);
              return { success: false, reason: 'exception', error: error.message };
            }
          });

          const results = await Promise.all(deletePromises);
          
          // Contar resultados
          const successCount = results.filter(r => r.success).length;
          const errorBatch = results.filter(r => !r.success).length;
          
          deletedCount += successCount;
          errorCount += errorBatch;

          // Log detalhado do lote
          console.log(`üìä Lote ${batchNumber}: ${successCount}/${batch.length} deletados, ${errorBatch} erros`);

          // Pausa entre lotes para n√£o sobrecarregar API do GitHub
          if (i + batchSize < githubFiles.length) {
            await new Promise(resolve => setTimeout(resolve, 1500));
          }
        }

        // Log final
        console.log(`üèÅ Limpeza GitHub conclu√≠da: ${deletedCount}/${githubFiles.length} arquivos removidos`);
        console.log(`üìà Taxa de sucesso: ${((deletedCount / githubFiles.length) * 100).toFixed(1)}%`);
        
        if (errorCount > 0) {
          console.warn(`‚ö†Ô∏è ${errorCount} arquivos com erro - podem n√£o existir mais ou falha de rede`);
        }

        // Mostrar resultado final
        LoadingManager.show(`üéâ Limpeza GitHub: ${deletedCount}/${githubFiles.length} arquivos removidos`);
        
        return { deleted: deletedCount, errors: errorCount, total: githubFiles.length };
      }

      // üóëÔ∏è LIMPAR FIRESTORE
      async cleanFirestore(requests) {
        // Deletar solicita√ß√µes em lotes
        const batchSize = 500; // Firestore limit
        
        for (let i = 0; i < requests.length; i += batchSize) {
          const batch = this.firebaseService.db.batch();
          const batchRequests = requests.slice(i, i + batchSize);
          
          batchRequests.forEach(request => {
            const docRef = this.firebaseService.db.collection('solicitacoes').doc(request.id);
            batch.delete(docRef);
          });

          await batch.commit();
          LoadingManager.show(`üóëÔ∏è Firestore: ${Math.min(i + batchSize, requests.length)}/${requests.length} removidos`);
        }

        // Limpar logs administrativos
        try {
          const logs = await this.firebaseService.getAdminLogs();
          if (logs.length > 0) {
            const logBatch = this.firebaseService.db.batch();
            logs.forEach(log => {
              const logRef = this.firebaseService.db.collection('admin_logs').doc(log.id);
              logBatch.delete(logRef);
            });
            await logBatch.commit();
          }
        } catch (error) {
          console.warn('‚ö†Ô∏è Erro ao limpar logs:', error);
        }
      }

      // üßπ LIMPAR CACHE LOCAL
      cleanLocalCache() {
        if (dashboardNotifications?.notificationManager) {
          dashboardNotifications.notificationManager.clearSeenRequests();
        }
        
        // Limpar outros caches se houver
        try {
          localStorage.removeItem('senai_stats');
          localStorage.removeItem('senai_cache');
        } catch (error) {
          console.warn('Erro ao limpar cache local:', error);
        }
      }

      // üõ†Ô∏è FUN√á√ïES AUXILIARES
      calculateDetailedStats(requests) {
        const stats = {
          geral: {
            total_solicitacoes: requests.length,
            periodo: {
              mais_antiga: requests.length > 0 ? Math.min(...requests.map(r => r.d)) : null,
              mais_recente: requests.length > 0 ? Math.max(...requests.map(r => r.d)) : null
            }
          },
          por_status: {},
          por_servico: {},
          por_mes: {},
          por_prioridade: {},
          com_arquivos: requests.filter(r => r.arq && r.arq.length > 0).length,
          com_comentarios: requests.filter(r => r.admin?.comentarios?.length > 0).length
        };

        // Agrupar estat√≠sticas
        requests.forEach(request => {
          // Por status
          const status = request.admin?.status || 'pendente';
          stats.por_status[status] = (stats.por_status[status] || 0) + 1;

          // Por servi√ßo
          const serviceKey = request.ts ? `${request.s}_${request.ts}` : request.s;
          const serviceName = this.getServiceDisplayName(serviceKey);
          stats.por_servico[serviceName] = (stats.por_servico[serviceName] || 0) + 1;

          // Por m√™s
          const date = new Date(request.d);
          const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
          stats.por_mes[monthKey] = (stats.por_mes[monthKey] || 0) + 1;

          // Por prioridade
          const priority = request.admin?.prioridade || 'sem_prioridade';
          stats.por_prioridade[priority] = (stats.por_prioridade[priority] || 0) + 1;
        });

        return stats;
      }

      generateCSV(requests, serviceType = 'all') {
        if (!requests.length) return 'Nenhuma solicita√ß√£o encontrada';

        const headers = ['ID', 'Data', 'Colaborador', 'Email', 'WhatsApp', 'Servi√ßo', 'Status', 'Prioridade', 'Qtd_Coment√°rios', 'Tem_Arquivos'];

        const csvData = requests.map(request => {
          const row = [
            request.id,
            new Date(request.d).toLocaleString('pt-BR'),
            request.c,
            request.e,
            request.w || '',
            this.getServiceDisplayName(request.ts ? `${request.s}_${request.ts}` : request.s),
            request.admin?.status || 'pendente',
            request.admin?.prioridade || '',
            request.admin?.comentarios?.length || 0,
            request.arq && request.arq.length > 0 ? 'Sim' : 'N√£o'
          ];

          return row.map(field => `"${String(field).replace(/"/g, '""')}"`).join(',');
        });

        return [headers.join(','), ...csvData].join('\n');
      }

      generateExecutiveSummary(firestoreData, downloadedFiles) {
        const { requests, stats, backupInfo } = firestoreData;
        const successfulDownloads = downloadedFiles.filter(f => f.downloaded).length;
        
        return `
üóÇÔ∏è BACKUP COMPLETO SENAI LAB
${'='.repeat(50)}

üìÖ Data do Backup: ${backupInfo.date}
üïê Timestamp: ${backupInfo.timestamp}
üìä Vers√£o: ${backupInfo.version}
üóÇÔ∏è Tipo: BACKUP COMPLETO COM LIMPEZA

üìã DADOS INCLU√çDOS
${'-'.repeat(30)}
‚Ä¢ Solicita√ß√µes Firestore: ${stats.geral.total_solicitacoes}
‚Ä¢ Arquivos GitHub baixados: ${successfulDownloads}/${downloadedFiles.length}
‚Ä¢ Logs administrativos: ${firestoreData.adminLogs.length}
‚Ä¢ Estat√≠sticas detalhadas: ‚úÖ

üìä ESTAT√çSTICAS RESUMIDAS
${'-'.repeat(30)}
‚Ä¢ Status mais comum: ${this.getMostCommon(stats.por_status)}
‚Ä¢ Servi√ßo mais usado: ${this.getMostCommon(stats.por_servico)}
‚Ä¢ Com arquivos anexados: ${stats.com_arquivos}
‚Ä¢ Com coment√°rios admin: ${stats.com_comentarios}

üíæ ARQUIVOS DE BACKUP
${'-'.repeat(30)}
‚Ä¢ dados_completos.json (dados principais)
‚Ä¢ solicitacoes_todas.csv (planilha geral)
‚Ä¢ estatisticas_detalhadas.json (m√©tricas)
‚Ä¢ arquivos_baixados.json (lista de arquivos)
‚Ä¢ Arquivos individuais do GitHub
‚Ä¢ CSVs por tipo de servi√ßo

üßπ LIMPEZA REALIZADA
${'-'.repeat(30)}
‚Ä¢ Firestore: ${stats.geral.total_solicitacoes} registros removidos
‚Ä¢ GitHub: ${downloadedFiles.length} arquivos removidos
‚Ä¢ Cache local: Limpo
‚Ä¢ Sistema: 100% zerado

üí∞ RESULTADO FINAL
${'-'.repeat(30)}
‚Ä¢ Custo Firebase: R$ 0,00 (zero registros)
‚Ä¢ Custo GitHub: R$ 0,00 (zero storage)
‚Ä¢ Performance: M√ÅXIMA
‚Ä¢ Dados: SEGUROS NO BACKUP

‚ö†Ô∏è IMPORTANTE
${'-'.repeat(30)}
Este backup cont√©m TODOS os dados e arquivos do sistema.
O sistema foi completamente limpo para manter custos zero.
Para restaurar, reimporte os dados conforme necess√°rio.

üìß Suporte: getulio.santos@docente.senai-ce.org.br
üîß Sistema: SENAI Lab Dashboard v2.0
        `.trim();
      }

      // Utilit√°rios
      downloadBlob(blob, filename) {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
      }

      getServiceName(service, subService) {
        const names = {
          'espaco_maker': 'Espa√ßo Maker',
          'servicos': {
            'impressao': 'Impress√£o',
            'impressao_3d': 'Impress√£o 3D',
            'manutencao': 'Manuten√ß√£o',
            'arte_digital': 'Arte Digital',
            'projeto': 'Projeto'
          },
          'emprestimo': 'Empr√©stimo'
        };

        if (service === 'servicos' && subService) {
          return names.servicos[subService] || subService;
        }

        return names[service] || service;
      }

      getServiceDisplayName(serviceKey) {
        const names = {
          'espaco_maker': 'Espa√ßo Maker',
          'servicos_impressao': 'Impress√£o',
          'servicos_impressao_3d': 'Impress√£o 3D',
          'servicos_manutencao': 'Manuten√ß√£o',
          'servicos_arte_digital': 'Arte Digital',
          'servicos_projeto': 'Projeto',
          'emprestimo': 'Empr√©stimo'
        };
        return names[serviceKey] || serviceKey;
      }

      groupRequestsByService(requests) {
        const groups = {};
        requests.forEach(request => {
          const key = request.ts ? `${request.s}_${request.ts}` : request.s;
          if (!groups[key]) groups[key] = [];
          groups[key].push(request);
        });
        return groups;
      }

      getFolderFromPath(path) {
        return path.split('/')[0] || 'outros';
      }

      getMostCommon(obj) {
        const entries = Object.entries(obj);
        if (entries.length === 0) return 'N/A';
        
        const sorted = entries.sort((a, b) => b[1] - a[1]);
        return `${sorted[0][0]} (${sorted[0][1]})`;
      }
    }

    // üéõÔ∏è INTEGRA√á√ÉO COM O DASHBOARD
    function addCompleteBackupButton() {
      const exportButtons = document.querySelector('.export-buttons');
      if (!exportButtons) {
        console.warn('‚ö†Ô∏è Container .export-buttons n√£o encontrado');
        return;
      }
      
      // Verificar se j√° existe o bot√£o (ID √∫nico)
      const existingBtn = document.getElementById('completeBackupBtn');
      if (existingBtn) {
        console.log('üîÑ Bot√£o de backup j√° existe, n√£o criando duplicata');
        return;
      }

      const backupBtn = document.createElement('button');
      backupBtn.id = 'completeBackupBtn'; // ID √∫nico para controle
      backupBtn.className = 'btn-export';
      backupBtn.style.cssText = `
        background: linear-gradient(45deg, #ff6b35, #f7931e);
        color: white;
        font-weight: 600;
        box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3);
        transition: all 0.3s ease;
      `;
      backupBtn.onclick = performCompleteBackup;
      backupBtn.innerHTML = 'üóÇÔ∏è Backup Completo + Limpar';
      backupBtn.title = 'Backup completo com arquivos + limpeza total (Firestore + GitHub)';
      
      // Verificar se j√° existe separador
      const existingSeparator = exportButtons.querySelector('.backup-separator');
      if (!existingSeparator) {
        const separator = document.createElement('div');
        separator.className = 'backup-separator';
        separator.style.cssText = 'width: 1px; height: 30px; background: #ddd; margin: 0 10px;';
        exportButtons.appendChild(separator);
      }
      
      exportButtons.appendChild(backupBtn);
      console.log('‚úÖ Bot√£o de backup completo adicionado');
    }

    // üöÄ EXECUTAR BACKUP COMPLETO
    async function performCompleteBackup() {
      if (!firebaseService) {
        ToastManager.show('Firebase service n√£o inicializado', 'error');
        return;
      }

      const backupManager = new CompleteBackupManager(firebaseService);
      await backupManager.createCompleteBackup();
    }

    // üîß INICIALIZAR SISTEMA
    function initializeCompleteBackupSystem() {
      // Verificar se o bot√£o j√° existe
      if (document.getElementById('completeBackupBtn')) {
        console.log('‚úÖ Bot√£o de backup j√° existe, n√£o criando duplicata');
        return;
      }
      
      // Aguardar um pouco para garantir que o DOM esteja carregado
      setTimeout(() => {
        // Garantir que o container existe antes de adicionar o bot√£o
        const exportButtons = document.querySelector('.export-buttons');
        if (exportButtons) {
          addCompleteBackupButton();
        } else {
          console.warn('‚ö†Ô∏è Container .export-buttons n√£o encontrado no DOM');
        }
      }, 500);
    }

    // üîí SISTEMA DE AUTENTICA√á√ÉO
    class AdminAuth {
      static isAuthenticated() {
        const session = localStorage.getItem(ADMIN_CONFIG.sessionKey);
        if (!session) return false;

        try {
          const data = JSON.parse(session);
          const now = Date.now();
          
          if (now > data.expires) {
            this.logout();
            return false;
          }
          
          return true;
        } catch {
          this.logout();
          return false;
        }
      }

      static login(password) {
        if (password === ADMIN_CONFIG.password) {
          const session = {
            timestamp: Date.now(),
            expires: Date.now() + ADMIN_CONFIG.sessionDuration
          };
          
          localStorage.setItem(ADMIN_CONFIG.sessionKey, JSON.stringify(session));
          return true;
        }
        return false;
      }

      static logout() {
        localStorage.removeItem(ADMIN_CONFIG.sessionKey);
      }
    }

    // üé® SISTEMA DE TOAST NOTIFICATIONS
    class ToastManager {
      static show(message, type = 'info', duration = 4000) {
        const toastContainer = document.getElementById('toastContainer');
        
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        
        const icons = {
          success: '‚úÖ',
          error: '‚ùå',
          warning: '‚ö†Ô∏è',
          info: '‚ÑπÔ∏è'
        };
        
        toast.innerHTML = `
          <span class="toast-icon">${icons[type] || icons.info}</span>
          <span class="toast-message">${message}</span>
          <button class="toast-close" onclick="this.parentElement.remove()">&times;</button>
        `;
        
        toastContainer.appendChild(toast);
        
        // Animar entrada
        setTimeout(() => toast.classList.add('show'), 100);
        
        // Remover automaticamente
        setTimeout(() => {
          toast.classList.remove('show');
          setTimeout(() => toast.remove(), 300);
        }, duration);
      }
    }

    // üîÑ SISTEMA DE LOADING
    class LoadingManager {
      static show(message = 'Carregando...') {
        const overlay = document.getElementById('loadingOverlay');
        const messageEl = document.getElementById('loadingMessage');
        messageEl.textContent = message;
        overlay.style.display = 'flex';
      }

      static hide() {
        const overlay = document.getElementById('loadingOverlay');
        overlay.style.display = 'none';
      }
    }

    // üìä SISTEMA DE DADOS AVAN√áADO
    class DashboardManager {
      static async loadStats() {
        try {
          const requests = await firebaseService.getAllRequests();
          currentRequests = requests;
          
          const stats = {
            total: requests.length,
            pending: requests.filter(r => !r.admin?.status || r.admin.status === 'pendente').length,
            inProgress: requests.filter(r => r.admin?.status === 'em_andamento').length,
            completed: requests.filter(r => r.admin?.status === 'concluido').length,
            cancelled: requests.filter(r => r.admin?.status === 'cancelado').length,
            today: requests.filter(r => {
              const today = new Date();
              const requestDate = new Date(r.d);
              return requestDate.toDateString() === today.toDateString();
            }).length
          };

          return { stats, requests };
        } catch (error) {
          console.error('‚ùå Erro ao carregar dados:', error);
          ToastManager.show('Erro ao carregar dados: ' + error.message, 'error');
          return { stats: {}, requests: [] };
        }
      }

      static async updateStatus(requestId, newStatus, comment = '') {
        try {
          LoadingManager.show('Atualizando status...');
          
          const success = await firebaseService.updateRequestStatus(requestId, newStatus, {
            comment: comment,
            responsavel: 'Administrador'
          });
          
          if (success) {
            ToastManager.show(`Status atualizado para: ${this.getStatusName(newStatus)}`, 'success');
            await loadDashboard();
          }
          
          LoadingManager.hide();
          return success;
        } catch (error) {
          LoadingManager.hide();
          ToastManager.show('Erro ao atualizar status', 'error');
          return false;
        }
      }

      static async setPriority(requestId, priority) {
        try {
          const success = await firebaseService.setPriority(requestId, priority);
          if (success) {
            ToastManager.show(`Prioridade definida: ${priority.toUpperCase()}`, 'success');
            await loadDashboard();
          }
          return success;
        } catch (error) {
          ToastManager.show('Erro ao definir prioridade', 'error');
          return false;
        }
      }

      static getStatusName(status) {
        const names = {
          'pendente': 'Pendente',
          'em_andamento': 'Em Andamento',
          'concluido': 'Conclu√≠do',
          'cancelado': 'Cancelado'
        };
        return names[status] || status;
      }
    }

    // üîê SISTEMA DE LOGIN/LOGOUT MODIFICADO
    function showDashboard() {
      document.getElementById('loginContainer').style.display = 'none';
      document.getElementById('dashboard').classList.add('show');
      
      // ‚ú® INICIALIZAR NOTIFICA√á√ïES
      if (!dashboardNotifications) {
        dashboardNotifications = new DashboardWithNotifications();
      }
      dashboardNotifications.onAdminLogin();
      
      loadDashboard();
    }

    function logout() {
      if (confirm('Tem certeza que deseja sair?')) {
        // ‚ú® PARAR NOTIFICA√á√ïES
        if (dashboardNotifications) {
          dashboardNotifications.onAdminLogout();
        }
        
        AdminAuth.logout();
        ToastManager.show('Logout realizado com sucesso!', 'success');
        showLogin();
      }
    }

    function showLogin() {
      document.getElementById('loginContainer').style.display = 'flex';
      document.getElementById('dashboard').classList.remove('show');
      document.getElementById('adminPassword').focus();
    }

    // üé® SISTEMA DE INTERFACE
    function updateStatsDisplay(stats) {
      document.getElementById('totalRequests').textContent = stats.total || 0;
      document.getElementById('pendingRequests').textContent = stats.pending || 0;
      document.getElementById('inProgressRequests').textContent = stats.inProgress || 0;
      document.getElementById('completedRequests').textContent = stats.completed || 0;

      // Atualizar indicadores de mudan√ßa
      document.getElementById('totalChange').textContent = `+${stats.today || 0} hoje`;
      document.getElementById('pendingChange').textContent = stats.pending > 5 ? 'Requer aten√ß√£o' : 'Sob controle';
      document.getElementById('progressChange').textContent = 'Em processo';
      document.getElementById('completedChange').textContent = 'Finalizadas';
    }

    function formatDate(timestamp) {
      return new Date(timestamp).toLocaleString('pt-BR');
    }

    function getServiceName(service, subService) {
      const names = {
        'espaco_maker': 'Espa√ßo Maker',
        'servicos': {
          'impressao': 'Impress√£o',
          'impressao_3d': 'Impress√£o 3D',
          'manutencao': 'Manuten√ß√£o',
          'arte_digital': 'Arte Digital',
          'projeto': 'Projeto'
        },
        'emprestimo': 'Empr√©stimo'
      };

      if (service === 'servicos' && subService) {
        return names.servicos[subService] || subService;
      }

      return names[service] || service;
    }

    function getStatusBadge(status) {
      const badges = {
        'pendente': '<span style="background: #ffeaa7; color: #d63031; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;">‚è≥ Pendente</span>',
        'em_andamento': '<span style="background: #74b9ff; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;">üîÑ Em Andamento</span>',
        'concluido': '<span style="background: #00b894; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;">‚úÖ Conclu√≠do</span>',
        'cancelado': '<span style="background: #d63031; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;">‚ùå Cancelado</span>'
      };
      
      return badges[status] || badges['pendente'];
    }

    function getPriorityClass(priority) {
      return priority ? `priority-${priority}` : '';
    }

    // üìã RENDERIZA√á√ÉO DA LISTA
    async function renderRequestsList(requests) {
      const container = document.getElementById('requestsList');
      
      if (requests.length === 0) {
        container.innerHTML = '<div class="loading"><p>Nenhuma solicita√ß√£o encontrada</p></div>';
        return;
      }

      let html = '';
      
      requests.forEach(request => {
        const status = request.admin?.status || 'pendente';
        const priority = request.admin?.prioridade || '';
        const serviceName = getServiceName(request.s, request.ts);
        const priorityClass = getPriorityClass(priority);
        
        html += `
          <div class="request-card ${priorityClass}" onclick="viewDetails('${request.id}')">
            ${priority ? `<div class="priority-indicator priority-${priority}">${priority.toUpperCase()}</div>` : ''}
            
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
              <div style="flex: 1;">
                <h3 style="color: #1e3c72; margin-bottom: 8px; font-size: 1.1rem;">
                  ${serviceName} - ${request.c}
                </h3>
                <p style="color: #666; font-size: 0.9rem; margin-bottom: 5px;">
                  üìß ${request.e} | üì± ${request.w || 'N/A'}
                </p>
                <p style="color: #888; font-size: 0.8rem;">
                  üìÖ ${formatDate(request.d)}
                </p>
              </div>
              <div style="text-align: right;">
                ${getStatusBadge(status)}
              </div>
            </div>
            
            <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
              <h4 style="color: #333; font-size: 0.9rem; margin-bottom: 8px;">üìã Detalhes:</h4>
              <div style="font-size: 0.85rem; color: #555;">
                ${formatRequestDetails(request)}
              </div>
              ${request.arq && request.arq.length > 0 ? `
                <div style="margin-top: 10px;">
                  <strong>üìé Arquivos:</strong>
                  ${request.arq.map(arquivo => `
                    <a href="${arquivo.u}" target="_blank" style="display: inline-block; margin: 5px 5px 0 0; padding: 4px 8px; background: #e3f2fd; color: #1976d2; text-decoration: none; border-radius: 4px; font-size: 0.8rem;">
                      üìÑ ${arquivo.n}
                    </a>
                  `).join('')}
                </div>
              ` : ''}
            </div>

            <div class="quick-actions" onclick="event.stopPropagation();">
              <select onchange="updateStatus('${request.id}', this.value)" class="quick-action" style="margin-right: 8px;">
                <option value="">Status</option>
                <option value="pendente" ${status === 'pendente' ? 'selected' : ''}>‚è≥ Pendente</option>
                <option value="em_andamento" ${status === 'em_andamento' ? 'selected' : ''}>üîÑ Em Andamento</option>
                <option value="concluido" ${status === 'concluido' ? 'selected' : ''}>‚úÖ Conclu√≠do</option>
                <option value="cancelado" ${status === 'cancelado' ? 'selected' : ''}>‚ùå Cancelado</option>
              </select>
              
              <select onchange="setPriority('${request.id}', this.value)" class="quick-action">
                <option value="">Prioridade</option>
                <option value="alta" ${priority === 'alta' ? 'selected' : ''}>üî¥ Alta</option>
                <option value="media" ${priority === 'media' ? 'selected' : ''}>üü° M√©dia</option>
                <option value="baixa" ${priority === 'baixa' ? 'selected' : ''}>üü¢ Baixa</option>
              </select>
              
              <button onclick="addComment('${request.id}')" class="quick-action comment">
                üí¨ Comentar
              </button>
              
              <button onclick="viewDetails('${request.id}')" class="quick-action details">
                üëÅÔ∏è Detalhes
              </button>
            </div>

            ${request.admin?.comentarios && request.admin.comentarios.length > 0 ? `
              <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee;">
                <h4 style="color: #333; font-size: 0.9rem; margin-bottom: 10px;">üí¨ Coment√°rios (${request.admin.comentarios.length}):</h4>
                ${request.admin.comentarios.slice(-2).map(comment => `
                  <div style="background: #f0f8ff; padding: 10px; margin-bottom: 8px; border-radius: 4px; border-left: 3px solid #2196f3;">
                    <div style="font-size: 0.85rem; color: #555; margin-bottom: 5px;">
                      <strong>${comment.autor}</strong> - ${formatDate(comment.timestamp)}
                    </div>
                    <div style="font-size: 0.9rem; color: #333;">
                      ${comment.texto}
                    </div>
                  </div>
                `).join('')}
                ${request.admin.comentarios.length > 2 ? `
                  <p style="font-size: 0.8rem; color: #666; text-align: center; margin-top: 5px;">
                    +${request.admin.comentarios.length - 2} coment√°rios mais antigos (clique em "Detalhes" para ver todos)
                  </p>
                ` : ''}
              </div>
            ` : ''}
          </div>
        `;
      });

      container.innerHTML = html;
    }

    // üéØ KANBAN BOARD
    function renderKanbanBoard(requests) {
      const statusColumns = {
        'pendente': document.getElementById('kanban-pendente'),
        'em_andamento': document.getElementById('kanban-em_andamento'),
        'concluido': document.getElementById('kanban-concluido'),
        'cancelado': document.getElementById('kanban-cancelado')
      };

      // Limpar colunas
      Object.values(statusColumns).forEach(column => {
        column.innerHTML = '';
      });

      // Agrupar por status
      const groupedRequests = {};
      requests.forEach(request => {
        const status = request.admin?.status || 'pendente';
        if (!groupedRequests[status]) {
          groupedRequests[status] = [];
        }
        groupedRequests[status].push(request);
      });

      // Renderizar cards em cada coluna
      Object.entries(groupedRequests).forEach(([status, requests]) => {
        const column = statusColumns[status];
        if (!column) return;

        requests.forEach(request => {
          const serviceName = getServiceName(request.s, request.ts);
          const priority = request.admin?.prioridade || '';
          
          const card = document.createElement('div');
          card.className = `kanban-card ${getPriorityClass(priority)}`;
          card.draggable = true;
          card.dataset.requestId = request.id;
          card.dataset.currentStatus = status;
          
          card.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
              <strong style="font-size: 0.9rem; color: #1e3c72;">${serviceName}</strong>
              ${priority ? `<span class="priority-indicator priority-${priority}" style="font-size: 0.7rem;">${priority.toUpperCase()}</span>` : ''}
            </div>
            <p style="font-size: 0.8rem; color: #666; margin-bottom: 8px;">${request.c}</p>
            <p style="font-size: 0.7rem; color: #888;">${formatDate(request.d)}</p>
            <div style="margin-top: 10px;">
              <button onclick="viewDetails('${request.id}')" style="font-size: 0.7rem; padding: 4px 8px; background: #e3f2fd; border: none; border-radius: 3px; cursor: pointer;">
                üëÅÔ∏è Ver
              </button>
              <button onclick="addComment('${request.id}')" style="font-size: 0.7rem; padding: 4px 8px; background: #f3e5f5; border: none; border-radius: 3px; cursor: pointer; margin-left: 5px;">
                üí¨ +
              </button>
            </div>
          `;

          // Drag and Drop events
          card.addEventListener('dragstart', handleDragStart);
          card.addEventListener('dragend', handleDragEnd);
          
          column.appendChild(card);
        });
      });

      // Setup drop zones
      Object.entries(statusColumns).forEach(([status, column]) => {
        column.addEventListener('dragover', handleDragOver);
        column.addEventListener('drop', (e) => handleDrop(e, status));
      });
    }

    // üéØ DRAG AND DROP HANDLERS
    function handleDragEnd(e) {
      e.target.classList.remove('dragging');
    }

    function handleDragOver(e) {
      e.preventDefault();
    }

    async function handleDrop(e, newStatus) {
      e.preventDefault();
      const requestId = e.dataTransfer.getData('text/plain');
      const card = document.querySelector(`[data-request-id="${requestId}"]`);
      const currentStatus = card.dataset.currentStatus;

      if (currentStatus !== newStatus) {
        await DashboardManager.updateStatus(requestId, newStatus);
      }
    }

    // üîÑ FUN√á√ïES DE INTERA√á√ÉO
    async function updateStatus(requestId, newStatus) {
      if (newStatus) {
        await DashboardManager.updateStatus(requestId, newStatus);
      }
    }

    async function setPriority(requestId, priority) {
      if (priority) {
        await DashboardManager.setPriority(requestId, priority);
      }
    }

    function addComment(requestId) {
      currentRequestId = requestId;
      document.getElementById('commentText').value = '';
      openModal('commentModal');
    }

    async function submitComment() {
      const comment = document.getElementById('commentText').value.trim();
      if (comment && currentRequestId) {
        try {
          LoadingManager.show('Adicionando coment√°rio...');
          const success = await firebaseService.addComment(currentRequestId, comment);
          if (success) {
            ToastManager.show('Coment√°rio adicionado com sucesso!', 'success');
            closeModal('commentModal');
            await loadDashboard();
          }
          LoadingManager.hide();
        } catch (error) {
          LoadingManager.hide();
          ToastManager.show('Erro ao adicionar coment√°rio', 'error');
        }
      }
    }

    function viewDetails(requestId) {
      const request = currentRequests.find(r => r.id === requestId);
      if (!request) return;

      const modalContent = document.getElementById('modalContent');
      const serviceName = getServiceName(request.s, request.ts);
      const status = request.admin?.status || 'pendente';
      const priority = request.admin?.prioridade || 'N√£o definida';

      modalContent.innerHTML = `
        <div style="margin-bottom: 20px;">
          <h3 style="color: #1e3c72; margin-bottom: 10px;">${serviceName} - ${request.c}</h3>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div>
              <strong>üìß Email:</strong> ${request.e}<br>
              <strong>üì± WhatsApp:</strong> ${request.w || 'N/A'}<br>
              <strong>üìÖ Data:</strong> ${formatDate(request.d)}
            </div>
            <div>
              <strong>Status:</strong> ${getStatusBadge(status)}<br>
              <strong>üéØ Prioridade:</strong> <span class="priority-${priority.toLowerCase()}">${priority}</span><br>
              <strong>üÜî ID:</strong> ${request.id}
            </div>
          </div>
        </div>

        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
          <h4 style="margin-bottom: 10px;">üìã Detalhes do Servi√ßo:</h4>
          ${formatRequestDetails(request)}
        </div>

        ${request.arq && request.arq.length > 0 ? `
          <div style="margin-bottom: 20px;">
            <h4 style="margin-bottom: 10px;">üìé Arquivos Anexados:</h4>
            ${request.arq.map(arquivo => `
              <div style="display: flex; align-items: center; gap: 10px; padding: 10px; background: #e3f2fd; border-radius: 6px; margin-bottom: 5px;">
                <span>üìÑ</span>
                <div style="flex: 1;">
                  <strong>${arquivo.n}</strong><br>
                  <small style="color: #666;">Tamanho: ${(arquivo.s / 1024).toFixed(1)} KB</small>
                </div>
                <a href="${arquivo.u}" target="_blank" style="padding: 5px 10px; background: #1976d2; color: white; text-decoration: none; border-radius: 4px; font-size: 0.8rem;">
                  Abrir
                </a>
              </div>
            `).join('')}
          </div>
        ` : ''}

        ${request.admin?.comentarios && request.admin.comentarios.length > 0 ? `
          <div>
            <h4 style="margin-bottom: 10px;">üí¨ Hist√≥rico de Coment√°rios:</h4>
            ${request.admin.comentarios.map(comment => `
              <div style="background: #f0f8ff; padding: 15px; margin-bottom: 10px; border-radius: 6px; border-left: 4px solid #2196f3;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                  <strong style="color: #1976d2;">${comment.autor}</strong>
                  <span style="color: #666; font-size: 0.85rem;">${formatDate(comment.timestamp)}</span>
                </div>
                <p style="margin: 0; line-height: 1.4;">${comment.texto}</p>
              </div>
            `).join('')}
          </div>
        ` : '<p style="color: #666; font-style: italic;">Nenhum coment√°rio administrativo.</p>'}

        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; text-align: center;">
          <button onclick="addComment('${request.id}')" style="margin-right: 10px; padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">
            üí¨ Adicionar Coment√°rio
          </button>
          <button onclick="closeModal('detailsModal')" style="padding: 10px 20px; background: #ccc; border: none; border-radius: 6px; cursor: pointer;">
            Fechar
          </button>
        </div>
      `;

      openModal('detailsModal');
    }

    function formatRequestDetails(request) {
      const service = request.s;
      const dados = request.dados || {};
      
      if (service === 'espaco_maker') {
        return `
          <strong>Data:</strong> ${dados.dr || 'N/A'}<br>
          <strong>Hor√°rio:</strong> ${dados.hi || 'N/A'} √†s ${dados.hf || 'N/A'}<br>
          <strong>Chrome Books:</strong> ${dados.cb ? `Sim (${dados.qcb || 0} unidades)` : 'N√£o'}<br>
          <strong>Computadores:</strong> ${dados.cp ? `Sim (${dados.qcp || 0} unidades)` : 'N√£o'}<br>
          <strong>Descri√ß√£o:</strong> ${dados.desc || 'N/A'}
        `;
      } else if (service === 'servicos') {
        const tipo = request.ts;
        
        if (tipo === 'impressao') {
          return `
            <strong>Tamanho:</strong> ${dados.tf || 'N/A'}<br>
            <strong>Quantidade:</strong> ${dados.qc || 0} c√≥pias<br>
            <strong>Frente e Verso:</strong> ${dados.fv ? 'Sim' : 'N√£o'}<br>
            <strong>Colorido:</strong> ${dados.co ? 'Sim' : 'N√£o'}<br>
            <strong>Escanear:</strong> ${dados.es ? 'Sim' : 'N√£o'}
          `;
        } else if (tipo === 'impressao_3d') {
          return `
            <strong>Material:</strong> ${dados.mt || 'N/A'}<br>
            <strong>Quantidade:</strong> ${dados.qt || 0}<br>
            <strong>Possui STL:</strong> ${dados.stl ? 'Sim' : 'N√£o'}<br>
            ${dados.dp ? `<strong>Descri√ß√£o:</strong> ${dados.dp}` : ''}
          `;
        } else if (tipo === 'manutencao') {
          return `<strong>Problema:</strong> ${dados.prob || 'N/A'}`;
        } else if (tipo === 'arte_digital' || tipo === 'projeto') {
          return `<strong>Descri√ß√£o:</strong> ${dados.desc || 'N/A'}`;
        }
      } else if (service === 'emprestimo') {
        return `
          <strong>Item:</strong> ${dados.ni || 'N/A'}<br>
          <strong>Retirada:</strong> ${dados.dr || 'N/A'}<br>
          <strong>Devolu√ß√£o:</strong> ${dados.dd || 'N/A'}
        `;
      }
      
      return 'Detalhes n√£o dispon√≠veis';
    }

    // üîç SISTEMA DE BUSCA E FILTROS
    function applySearchFilter() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      
      if (!searchTerm) {
        filteredRequests = applyFilters(currentRequests);
      } else {
        filteredRequests = currentRequests.filter(request => {
          const searchableText = [
            request.c,
            request.e,
            request.w,
            getServiceName(request.s, request.ts),
            JSON.stringify(request.dados)
          ].join(' ').toLowerCase();
          
          return searchableText.includes(searchTerm);
        });
        
        filteredRequests = applyFilters(filteredRequests);
      }
      
      if (currentViewMode === 'list') {
        renderRequestsList(filteredRequests);
      } else {
        renderKanbanBoard(filteredRequests);
      }
    }

    function applyFilters(requests) {
      const serviceFilter = document.getElementById('filterService').value;
      const statusFilter = document.getElementById('filterStatus').value;
      const priorityFilter = document.getElementById('filterPriority').value;
      const periodFilter = document.getElementById('filterPeriod').value;

      let filtered = requests;

      // Filtro por servi√ßo
      if (serviceFilter) {
        filtered = filtered.filter(r => r.s === serviceFilter);
      }

      // Filtro por status
      if (statusFilter) {
        filtered = filtered.filter(r => {
          const status = r.admin?.status || 'pendente';
          return status === statusFilter;
        });
      }

      // Filtro por prioridade
      if (priorityFilter) {
        filtered = filtered.filter(r => r.admin?.prioridade === priorityFilter);
      }

      // Filtro por per√≠odo
      if (periodFilter !== 'todos') {
        const now = new Date();
        const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const startOfWeek = new Date(startOfDay);
        startOfWeek.setDate(startOfDay.getDate() - startOfDay.getDay());
        const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);

        filtered = filtered.filter(r => {
          const requestDate = new Date(r.d);
          
          switch (periodFilter) {
            case 'hoje':
              return requestDate >= startOfDay;
            case 'semana':
              return requestDate >= startOfWeek;
            case 'mes':
              return requestDate >= startOfMonth;
            default:
              return true;
          }
        });
      }

      return filtered.sort((a, b) => b.d - a.d); // Ordenar por data (mais recente primeiro)
    }

    // üéØ CONTROLES DE VISUALIZA√á√ÉO
    function toggleViewMode() {
      const listView = document.getElementById('listView');
      const kanbanView = document.getElementById('kanbanView');
      const viewModeBtn = document.getElementById('viewModeBtn');

      if (currentViewMode === 'list') {
        currentViewMode = 'kanban';
        listView.style.display = 'none';
        kanbanView.style.display = 'block';
        viewModeBtn.innerHTML = 'üìã Alternar para Lista';
        renderKanbanBoard(filteredRequests);
      } else {
        currentViewMode = 'list';
        listView.style.display = 'block';
        kanbanView.style.display = 'none';
        viewModeBtn.innerHTML = 'üìã Alternar para Kanban';
        renderRequestsList(filteredRequests);
      }
    }

    function filterByStatus(status) {
      document.getElementById('filterStatus').value = status;
      loadDashboard();
    }

    // üéõÔ∏è MODAIS
    function openModal(modalId) {
      const modal = document.getElementById(modalId);
      modal.classList.add('show');
      document.body.style.overflow = 'hidden';
    }

    function closeModal(modalId) {
      const modal = document.getElementById(modalId);
      modal.classList.remove('show');
      document.body.style.overflow = 'auto';
    }

    // üìä EXPORTA√á√ÉO DE DADOS
    function exportToExcel() {
      ToastManager.show('Preparando exporta√ß√£o para Excel...', 'info');
      
      // Criar dados para exporta√ß√£o
      const exportData = filteredRequests.map(request => ({
        'ID': request.id,
        'Data': formatDate(request.d),
        'Colaborador': request.c,
        'Email': request.e,
        'WhatsApp': request.w || '',
        'Servi√ßo': getServiceName(request.s, request.ts),
        'Status': request.admin?.status || 'pendente',
        'Prioridade': request.admin?.prioridade || '',
        'Coment√°rios': request.admin?.comentarios?.length || 0
      }));

      // Converter para CSV (simula√ß√£o - em produ√ß√£o use uma lib como XLSX)
      const csv = convertToCSV(exportData);
      downloadFile(csv, 'senai-lab-solicitacoes.csv', 'text/csv');
      
      ToastManager.show('Arquivo Excel exportado com sucesso!', 'success');
    }

    function exportToPDF() {
      ToastManager.show('Exporta√ß√£o PDF em desenvolvimento...', 'warning');
      // TODO: Implementar exporta√ß√£o PDF
    }

    function convertToCSV(data) {
      if (!data.length) return '';
      
      const headers = Object.keys(data[0]);
      const csvContent = [
        headers.join(','),
        ...data.map(row => headers.map(header => `"${row[header] || ''}"`).join(','))
      ].join('\n');
      
      return csvContent;
    }

    function downloadFile(content, fileName, mimeType) {
      const blob = new Blob([content], { type: mimeType });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = fileName;
      document.body.appendChild(a);
      a.click();
      window.URL.revokeObjectURL(url);
      document.body.removeChild(a);
    }

    // üîÑ CARREGAMENTO DO DASHBOARD
    async function loadDashboard() {
      try {
        LoadingManager.show('Carregando dados do dashboard...');
        
        const { stats, requests } = await DashboardManager.loadStats();
        
        updateStatsDisplay(stats);
        
        filteredRequests = applyFilters(requests);
        
        if (currentViewMode === 'list') {
          await renderRequestsList(filteredRequests);
        } else {
          renderKanbanBoard(filteredRequests);
        }
        
        LoadingManager.hide();
        ToastManager.show(`Dashboard atualizado! ${filteredRequests.length} solicita√ß√µes carregadas.`, 'success');
        
        // ‚ú® INICIALIZAR SISTEMA DE BACKUP COMPLETO (apenas uma vez)
        setTimeout(() => {
          initializeCompleteBackupSystem();
        }, 1000);
        
      } catch (error) {
        LoadingManager.hide();
        console.error('‚ùå Erro ao carregar dashboard:', error);
        ToastManager.show('Erro ao carregar dashboard', 'error');
      }
    }

    // üîê SISTEMA DE LOGIN/LOGOUT
    document.getElementById('loginForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const password = document.getElementById('adminPassword').value;
      const loginBtn = document.getElementById('loginBtn');
      const loginText = document.getElementById('loginText');
      const loginLoading = document.getElementById('loginLoading');
      const errorDiv = document.getElementById('loginError');

      // UI de loading
      loginBtn.disabled = true;
      loginText.style.display = 'none';
      loginLoading.style.display = 'inline';
      errorDiv.style.display = 'none';

      // Simular delay de verifica√ß√£o
      setTimeout(() => {
        if (AdminAuth.login(password)) {
          ToastManager.show('Login realizado com sucesso!', 'success');
          showDashboard();
        } else {
          errorDiv.textContent = '‚ùå Senha incorreta. Tente novamente.';
          errorDiv.style.display = 'block';
          
          // Reset do formul√°rio
          loginBtn.disabled = false;
          loginText.style.display = 'inline';
          loginLoading.style.display = 'none';
          document.getElementById('adminPassword').value = '';
          document.getElementById('adminPassword').focus();
        }
      }, 1000);
    });

    // üì± EVENT LISTENERS
    document.getElementById('filterService').addEventListener('change', loadDashboard);
    document.getElementById('filterStatus').addEventListener('change', loadDashboard);
    document.getElementById('filterPriority').addEventListener('change', loadDashboard);
    document.getElementById('filterPeriod').addEventListener('change', loadDashboard);

    // Fechar modal clicando fora
    window.addEventListener('click', function(e) {
      if (e.target.classList.contains('modal')) {
        e.target.classList.remove('show');
        document.body.style.overflow = 'auto';
      }
    });

    // ‚ö° INICIALIZA√á√ÉO
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üîß SENAI Lab - Dashboard Administrativo v2.0 com Backup Completo Iniciado');
      
      // Inicializar Firebase Service
      try {
        firebaseService = new FirebaseService();
        console.log('‚úÖ Firebase Service inicializado');
      } catch (error) {
        console.error('‚ùå Erro ao inicializar Firebase:', error);
        ToastManager.show('Erro ao conectar com Firebase', 'error');
        return;
      }
      
      // Verificar se j√° est√° autenticado
      if (AdminAuth.isAuthenticated()) {
        showDashboard();
      } else {
        showLogin();
      }

      // Auto-refresh a cada 30 segundos se estiver autenticado
      setInterval(() => {
        if (AdminAuth.isAuthenticated() && document.getElementById('dashboard').classList.contains('show')) {
          loadDashboard();
        }
      }, 30000);

      // Mostrar toast de boas-vindas
      setTimeout(() => {
        if (AdminAuth.isAuthenticated()) {
          ToastManager.show('Dashboard v2.0 com Backup Completo carregado! üöÄ', 'success');
        }
      }, 1000);
    });

    console.log(`
üóÇÔ∏è SENAI Lab - Dashboard com Sistema de Backup Completo + Limpeza

üÜï NOVIDADES - SISTEMA DE BACKUP COMPLETO:
    ‚úÖ Backup completo Firestore + GitHub
    ‚úÖ Download de TODOS os arquivos
    ‚úÖ M√∫ltiplos formatos (JSON, CSV, TXT)
    ‚úÖ Limpeza total autom√°tica
    ‚úÖ Sistema 100% gratuito mantido
    ‚úÖ Notifica√ß√µes desktop nativas
    ‚úÖ Monitoramento em tempo real

üîî Recursos mantidos:
    ‚úÖ Toast notifications elegantes
    ‚úÖ Modal de detalhes completos
    ‚úÖ Busca por texto em tempo real
    ‚úÖ Vista Kanban com drag & drop
    ‚úÖ Sistema de prioridades
    ‚úÖ Exporta√ß√£o para Excel
    ‚úÖ Interface responsiva
    ‚úÖ Coment√°rios expandidos

üöÄ Fluxo do Backup Completo:
    1. Coleta dados Firestore
    2. Baixa TODOS os arquivos GitHub
    3. Gera backup completo
    4. Apaga TUDO do Firestore
    5. Apaga TUDO do GitHub
    6. Sistema volta ao estado inicial

üí∞ RESULTADO: CUSTO ZERO PERMANENTE

‚ö†Ô∏è  CONFIGURA√á√ÉO DE SEGURAN√áA:
    Altere a senha em ADMIN_CONFIG.password
    Senha atual: "${ADMIN_CONFIG.password}"
    
üéâ NOVO: Bot√£o "üóÇÔ∏è Backup Completo + Limpar" dispon√≠vel!
    `);

    // üéØ DRAG AND DROP HANDLERS
    function handleDragStart(e) {
      e.dataTransfer.setData('text/plain', e.target.dataset.requestId);
      e.target.classList.add('dragging');
    }
  </script>
</body>
</html>