name: Deploy to Firebase Hosting

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Instalar Firebase CLI
        run: npm install -g firebase-tools

      - name: Verificar versÃ£o atual
        id: get_version
        run: |
          VERSION=$(grep -o 'content="v[0-9]\+\.[0-9]\+\.[0-9]\+"' public/index.html | sed 's/content="v//;s/"$//' || echo "unknown")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ VersÃ£o detectada: v$VERSION"

      - name: Deploy para Firebase
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
        run: |
          echo "ðŸš€ Iniciando deploy para Firebase Hosting..."

          if [ -z "$FIREBASE_TOKEN" ]; then
            echo "âš ï¸ FIREBASE_TOKEN nÃ£o configurado"
            echo "Para configurar:"
            echo "1. Execute: firebase login:ci"
            echo "2. Copie o token gerado"
            echo "3. Adicione em: Settings > Secrets > FIREBASE_TOKEN"
            echo ""
            echo "â­ï¸ Pulando deploy por enquanto..."
            exit 0
          fi

          firebase deploy --only hosting --token "$FIREBASE_TOKEN" --non-interactive

      - name: Deploy bem-sucedido
        if: success()
        run: |
          echo "âœ… Deploy concluÃ­do com sucesso!"
          echo "ðŸŒ VersÃ£o: v${{ steps.get_version.outputs.version }}"
          echo "ðŸ“… Data: $(date)"

      - name: Notificar falha
        if: failure()
        run: |
          echo "âŒ Deploy falhou!"
          echo "Verifique os logs acima para mais detalhes"

      - name: Criar release notes
        if: success()
        run: |
          echo "# ðŸš€ Deploy AutomÃ¡tico" > DEPLOY_NOTES.md
          echo "" >> DEPLOY_NOTES.md
          echo "**VersÃ£o:** v${{ steps.get_version.outputs.version }}" >> DEPLOY_NOTES.md
          echo "**Data:** $(date +'%d/%m/%Y %H:%M')" >> DEPLOY_NOTES.md
          echo "**Branch:** ${{ github.ref_name }}" >> DEPLOY_NOTES.md
          echo "**Commit:** ${{ github.sha }}" >> DEPLOY_NOTES.md
          echo "" >> DEPLOY_NOTES.md
          echo "## Ãšltimos commits:" >> DEPLOY_NOTES.md
          git log -3 --pretty=format:"- %s (%h)" >> DEPLOY_NOTES.md
          echo "" >> DEPLOY_NOTES.md
          echo "" >> DEPLOY_NOTES.md
          echo "---" >> DEPLOY_NOTES.md
          echo "Gerado automaticamente por GitHub Actions" >> DEPLOY_NOTES.md

          cat DEPLOY_NOTES.md

      - name: Upload deploy notes
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: deploy-notes
          path: DEPLOY_NOTES.md
          retention-days: 30
